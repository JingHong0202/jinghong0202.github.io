<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="node">
    <meta name="description" content="Nodejs编程
第0章 Node介绍0.0 回顾 JavaScript
*历史及发展 *
1995年 网景公司的布兰登开发；
1997年7月，ECMA组织发布ECMAScript 1.0版;
2007年10月发布3.1版本后不久，ECMA">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="baidu-site-verification" content="LOg3u41Vsp" />
    <meta name="sogou_site_verification" content="r2b9FKw94y"/>
    <title>Node | Jing Hong</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/JingHong0202/blog/medias/logo.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JingHong0202/blog/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JingHong0202/blog/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/jquery/jquery.min.js"></script>
    
<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="Jing Hong" type="application/atom+xml">
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>


<body>
        <div class="load-mask">
      <div class="load">
          <img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" alt='loading'>
      </div>
    </div>
<header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                   <div style='white-space:nowrap'>
                        
                        <img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog/medias/avatar.jpg" class="logo-img" alt="LOGO">
                        
                        <span class="logo-span">Jing Hong</span>
                   </div>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>

<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog/medias/avatar.jpg" class="logo-img circle responsive-img">
        
        <div class="logo-name">Jing Hong</div>
        <div class="logo-desc">
            
            编程袁一只！专注编程！！！
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
    </ul>
</div>

        </div>

        
    </nav>

</header>

    
<script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/cryptojs/crypto-js.min.js"></script>
<script>
    (function() {
        let pwd = '';
        if (pwd && pwd.length > 0) {
            if (pwd !== CryptoJS.SHA256(prompt('请输入访问本文章的密码')).toString(CryptoJS.enc.Hex)) {
                alert('密码错误，将返回主页！');
                location.href = '/';
            }
        }
    })();
</script>




<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/JingHong0202/blog/medias/featureimages/18.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Node</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        height: calc(100vh - 250px);
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/JavaScript/">
                                <span class="chip bg-color">JavaScript</span>
                            </a>
                        
                            <a href="/tags/Node/">
                                <span class="chip bg-color">Node</span>
                            </a>
                        
                            <a href="/tags/express/">
                                <span class="chip bg-color">express</span>
                            </a>
                        
                            <a href="/tags/Koa/">
                                <span class="chip bg-color">Koa</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/Back/" class="post-category">
                                Back
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2019-10-11
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    15.5k
                </div>
                

                

                
            </div>

        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Nodejs编程"><a href="#Nodejs编程" class="headerlink" title="Nodejs编程"></a>Nodejs编程</h1><hr>
<h2 id="第0章-Node介绍"><a href="#第0章-Node介绍" class="headerlink" title="第0章 Node介绍"></a>第0章 Node介绍</h2><h3 id="0-0-回顾-JavaScript"><a href="#0-0-回顾-JavaScript" class="headerlink" title="0.0 回顾 JavaScript"></a>0.0 回顾 JavaScript</h3><ul>
<li><p>*<em>历史及发展 *</em></p>
<p>1995年 网景公司的布兰登开发；</p>
<p>1997年7月，ECMA组织发布ECMAScript 1.0版;</p>
<p>2007年10月发布3.1版本后不久，ECMAScript 3.1改名为 ECMAScript 5。</p>
<p>2008年，为Chrome浏览器而开发的V8编译器诞生</p>
<p>2011年6月，ECMAscript 5.1版发布，现在使用最为广泛的版本;</p>
<p>2015年6月，ECMAScript 6正式发布，并且更名为“ECMAScript 2015”;</p>
</li>
<li><p><strong>如何学习JavaScript</strong></p>
<p>JavaScript 的核心语法部分相当精简，也就是语言本身，只包括两个部分:</p>
<ul>
<li><p>基本的语法构造(比如操作符、控制结构、语句)</p>
</li>
<li><p>标准库(就是一系列具有各种功能的对象比如Array、Date、Math等)。</p>
</li>
</ul>
</li>
</ul>
<p>  想要实现其他复杂的操作和效果，都要依靠 <strong>宿主环境</strong> 提供API，目前，已经嵌入 JavaScript 的宿主环境有多种，最常见的环境就是 <strong>浏览器</strong> 和 <strong>操作系统</strong> ;</p>
<ul>
<li><strong>回顾 JavaScript 语法特性</strong><ul>
<li>变量、数据类型、流程控制</li>
<li>函数(基本声明参数，作用域，回调函数)、面向对象(原型，构造函数，this的指向，new的过程)</li>
</ul>
</li>
</ul>
<h3 id="0-1-Node是什么"><a href="#0-1-Node是什么" class="headerlink" title="0.1 Node是什么"></a>0.1 Node是什么</h3><p><code>Node</code>  是一个基于<code>Chrome V8</code> 引擎的<code>JavaScript</code> 运行环境。  </p>
<p><code>Node</code>  不是一种独立的语言、<code>Node</code>不是 <code>JavaScript</code> 框架，</p>
<p><code>Node</code>是一个<strong>除了浏览器之外的、可以让<code>JavaScript</code> 运行的环境</strong></p>
<p>Node.js 是一个让 JavaScript 运行在服务端的开发平台，是使用 事件驱动， 异步非阻塞I/O，单线程，跨平台的 JS 运行环境；</p>
<h3 id="0-2-为什么要学习-Node"><a href="#0-2-为什么要学习-Node" class="headerlink" title="0.2. 为什么要学习 Node"></a>0.2. 为什么要学习 Node</h3><ul>
<li>打开服务器的黑盒子</li>
<li>企业需求</li>
<li>大前端必备技能</li>
<li>为了更好的学习前端框架</li>
</ul>
<h3 id="0-3-Node-能做什么"><a href="#0-3-Node-能做什么" class="headerlink" title="0.3. Node 能做什么"></a>0.3. Node 能做什么</h3><p><a href="https://www.zhihu.com/question/20796866" target="_blank" rel="noopener">知乎 - Node.js能做什么，该做什么？</a></p>
<ul>
<li>Web 服务器(重点)</li>
<li>命令行工具</li>
<li>网络爬虫:是一种按照一定的规则，自动地抓取网站信息的程序</li>
<li>桌面应用程序开发</li>
</ul>
<h3 id="0-4-一些资源"><a href="#0-4-一些资源" class="headerlink" title="0.4. 一些资源"></a>0.4. 一些资源</h3><ol>
<li><p>文档</p>
<p><a href="https://nodejs.org/en/docs/" target="_blank" rel="noopener">Node.js 官方文档</a><br><a href="http://nodejs.cn/" target="_blank" rel="noopener">Node.js 中文文档（非官方）</a></p>
</li>
<li><p>书籍</p>
<p><a href="https://read.douban.com/ebook/12053349/" target="_blank" rel="noopener">深入浅出 Node.js</a><br><a href="https://book.douban.com/subject/25892704/" target="_blank" rel="noopener">Node.js 权威指南</a><br><a href="https://book.douban.com/subject/25870705/" target="_blank" rel="noopener">Node.js 实战</a><br><a href="https://book.douban.com/subject/26642320/" target="_blank" rel="noopener">Node.js实战（第2季）</a></p>
</li>
<li><p>github资源</p>
<p><a href="https://github.com/alsotang/node-lessons" target="_blank" rel="noopener">Node.js 包教不包会</a><br><a href="http://es6.ruanyifeng.com/" target="_blank" rel="noopener">ECMAScript 6 入门</a><br><a href="https://github.com/nqdeng/7-days-nodejs" target="_blank" rel="noopener">七天学会 NodeJS</a> </p>
</li>
<li><p>社区</p>
<p><strong><a href="https://cnodejs.org/" target="_blank" rel="noopener">Node.js 中文社区</a></strong> </p>
</li>
</ol>
<h3 id="0-5-Node-发展历史"><a href="#0-5-Node-发展历史" class="headerlink" title="0.5. Node 发展历史"></a>0.5. Node 发展历史</h3><p><a href="https://gitbook.cn/books/58e796fd09012f0a48761eae/index.html" target="_blank" rel="noopener">聊聊 Node.js 的历史</a><br><a href="https://cnodejs.org/topic/555d3d54e684c4c8088a0d78" target="_blank" rel="noopener">来自朴灵大大的 – Node.js 简史</a></p>
<h2 id="第1章-NodeJS起步"><a href="#第1章-NodeJS起步" class="headerlink" title="第1章 NodeJS起步"></a>第1章 NodeJS起步</h2><h3 id="1-1-下载安装"><a href="#1-1-下载安装" class="headerlink" title="1.1 下载安装"></a>1.1 下载安装</h3><ul>
<li>下载 <a href="https://nodejs.org/zh-cn/download/" target="_blank" rel="noopener">https://nodejs.org/zh-cn/download/</a></li>
</ul>
<ul>
<li>历史版本：<a href="https://nodejs.org/en/download/releases/" target="_blank" rel="noopener">https://nodejs.org/en/download/releases/</a></li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-16_18-20-26.png" alt=""></p>
<p>windows下安装过程：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-16_18-20-59.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-16_18-29-26.png" alt=""></p>
<p>对于已经装过的，重新安装就会升级</p>
<p>安装成功后，打开命令行，输入 </p>
<p>node –version 或者 node -v  (显示node的版本号)</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-16_18-31-59.png" alt=""></p>
<p>表示安装成功</p>
<p>其他平台的安装方式：</p>
<p><a href="https://nodejs.org/zh-cn/download/package-manager/" target="_blank" rel="noopener">https://nodejs.org/zh-cn/download/package-manager/</a></p>
<h3 id="1-2-REPL环境"><a href="#1-2-REPL环境" class="headerlink" title="1.2 REPL环境"></a>1.2 REPL环境</h3><p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-16_18-40-26.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-16_18-41-36.png" alt=""></p>
<p>node中的REPL环境类似于浏览器中的 Console控制台 ，可以做一些代码测试。</p>
<p>按ctrl + 两次c 退出REPL环境</p>
<p>但是, 我们写代码肯定不是在控制台中写,而是写在一个单独的.js文件中.</p>
<h3 id="1-3-node运行js代码"><a href="#1-3-node运行js代码" class="headerlink" title="1.3 node运行js代码"></a>1.3 node运行js代码</h3><p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-16_18-52-40.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-16_18-53-36.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-16_18-49-49.png" alt=""></p>
<h3 id="1-4-Node-中的模块"><a href="#1-4-Node-中的模块" class="headerlink" title="1.4 Node 中的模块"></a>1.4 Node 中的模块</h3><p><strong>浏览器(客户端)中的JS</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-16_18-53-39.png" alt=""></p>
<p><strong>Node中的JS</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-17_16-40-25.png" alt=""></p>
<h2 id="Buffer（二进制数据操作）"><a href="#Buffer（二进制数据操作）" class="headerlink" title="Buffer（二进制数据操作）"></a>Buffer（二进制数据操作）</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">let</span> buffer<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token string">'abc\r\nddasdfafd\r\ndfaerewtwert'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> buffer2<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span><span class="token string">'\r\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>buffer2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//Buffer.concat 可以传入一个装有buffer的数组，之后会自动拼接返回</span>
<span class="token comment" spellcheck="true">//buffer数据可以用toString、queryString模块的的parse 转换为看的懂的数据</span></code></pre>
<h2 id="第2章-核心模块的使用"><a href="#第2章-核心模块的使用" class="headerlink" title="第2章 核心模块的使用"></a>第2章 核心模块的使用</h2><h3 id="2-1-FS模块"><a href="#2-1-FS模块" class="headerlink" title="2.1 FS模块"></a>2.1 FS模块</h3><p>node核心模块之一，用于操作文件；</p>
<p>中文手册 : <a href="http://nodejs.cn/api/fs.html" target="_blank" rel="noopener">http://nodejs.cn/api/fs.html</a></p>
<ul>
<li>文件读写 </li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入模块</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// console.log(typeof fs); //object </span>

<span class="token comment" spellcheck="true">// 向文件中写入内容</span>
fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'./2.1.txt'</span><span class="token punctuation">,</span><span class="token string">'itcast'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span>cb2<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 回调函数 (写入成功后执行的函数)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>cb2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 从文件中读取内容</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./2.1.txt'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 回调函数 (读取成功后执行的函数)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<ul>
<li>追加内容</li>
</ul>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 引入模块</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 向文件中追加内容</span>
fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./2.1.txt'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span>d<span class="token punctuation">)</span><span class="token punctuation">{</span>
    d<span class="token operator">+</span><span class="token operator">=</span><span class="token string">'2344'</span><span class="token punctuation">;</span>
    fs<span class="token punctuation">.</span><span class="token function">writeFile</span><span class="token punctuation">(</span><span class="token string">'./2.1.txt'</span><span class="token punctuation">,</span>d<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入失败'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'写入成功'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="Zilb模块"><a href="#Zilb模块" class="headerlink" title="Zilb模块"></a>Zilb模块</h4><h3 id="2-2-HTTP模块"><a href="#2-2-HTTP模块" class="headerlink" title="2.2 HTTP模块"></a>2.2 HTTP模块</h3><p>node核心模块之一，用于搭建HTTP服务器；</p>
<p>中文手册 <a href="http://nodejs.cn/api/http.html" target="_blank" rel="noopener">http://nodejs.cn/api/http.html</a></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-17_21-03-59.png" alt=""></p>
<h4 id="2-2-1-开启服务器"><a href="#2-2-1-开启服务器" class="headerlink" title="2.2.1 开启服务器"></a>2.2.1 开启服务器</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 1. 导入http模块</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 2. 使用http这个模块中的createServer()创建一个服务器实例对象</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 3. 绑定端口号,启动web服务器</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' 请访问http://localhost:8000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 4. 为这个服务器实例对象注册 request 请求处理函数</span>
<span class="token comment" spellcheck="true">// 请求处理函数function(形参1,形参2){}</span>
<span class="token comment" spellcheck="true">// 形参1:request请求对象 获取到当前请求的路径,方法等本次请求的所有信息</span>
<span class="token comment" spellcheck="true">// 形参2:response响应对象 发送响应数据</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'服务端收到客户端的请求啦!!!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 向客户端页面返回字符串</span>
    response<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"hello node"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 结束响应</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-17_21-18-39.png" alt=""></p>
<p>因为我们的服务器接受请求处理并响应数据时，并没有指定响应数据的类型，所以出现了乱码；</p>
<p>而在http中，我们可以通过服务器的响应头指定数据类型，在 <a href="http://nodejs.cn/api/http.html#http_class_http_serverresponse" target="_blank" rel="noopener">http.ServerResponse 类</a> 中为我们提供了setHeader 方法：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-17_21-34-56.png" alt=""></p>
<h4 id="2-2-2-响应-HTML-页面"><a href="#2-2-2-响应-HTML-页面" class="headerlink" title="2.2.2 响应 HTML 页面"></a>2.2.2 响应 HTML 页面</h4><p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-17_21-41-23.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-17_21-45-00.png" alt=""></p>
<p>但是，我们不能一直将html代码写到服务器的方法中，而是需要建一个xx.html的文件，将html文件中的内容返回给客户端；</p>
<p>2.2.2 .html :</p>
<pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>你好，我是西岭老湿<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>另外，我还很帅……<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<p>nodejs代码</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 1:引入文件操作模块</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 2：读取html文件中的内容</span>
    fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./2.2.2.html'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>html_data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 设置响应头</span>
        response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 将html中的内容响应回客户端，结束响应</span>
        response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="2-2-3-响应图片"><a href="#2-2-3-响应图片" class="headerlink" title="2.2.3 响应图片"></a>2.2.3 响应图片</h4><pre class=" language-html"><code class="language-html"><span class="token doctype">&lt;!DOCTYPE html></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>en<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>你好，我是西岭老湿<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>另外，我还很帅……<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./img/03.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>野生脆脆.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<pre class=" language-js"><code class="language-js">server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// url 属性返回请求的URL字符串</span>
    <span class="token keyword">var</span> urls <span class="token operator">=</span> request<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> urls <span class="token operator">==</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./2.2.2.html'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>html_data<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 设置响应头</span>
            response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将html中的内容响应回客户端，结束响应</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>urls<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token string">'jpg'</span><span class="token punctuation">)</span><span class="token operator">>=</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// 判断请求图片</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./img/03.jpg'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>html_data<span class="token punctuation">)</span><span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h4 id="2-2-4-响应其他静态资源"><a href="#2-2-4-响应其他静态资源" class="headerlink" title="2.2.4 响应其他静态资源"></a>2.2.4 响应其他静态资源</h4><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>UTF-8<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">></span></span>Document<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>stylesheet<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./public/h.css<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>你好，我是西岭老湿<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>另外，我还很帅……<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>img</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./img/03.jpg<span class="token punctuation">"</span></span> <span class="token attr-name">alt</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>野生脆脆.jpg<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>./public/h.js<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token script language-javascript"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">></span></span></code></pre>
<pre class=" language-js"><code class="language-js">server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// url 属性返回请求的URL字符串</span>
    <span class="token keyword">var</span> urls <span class="token operator">=</span> request<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> urls <span class="token operator">==</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./2.2.2.html'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>html_data<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 设置响应头</span>
            response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将html中的内容响应回客户端，结束响应</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token operator">+</span>urls<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>html_data<span class="token punctuation">)</span><span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h3 id="2-3-服务器遍历文件及文件夹-案例"><a href="#2-3-服务器遍历文件及文件夹-案例" class="headerlink" title="2.3 服务器遍历文件及文件夹-案例"></a>2.3 服务器遍历文件及文件夹-案例</h3><p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-22_16-03-32.png" alt=""></p>
<p>模仿Apache服务器，遍历文件及文件，显示时间及大小；</p>
<p>右键另存为，下载页面当作静态页面模板使用；</p>
<p>使用node载入静态页面：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img%5CSnipaste_2018-09-22_16-08-10.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-22_16-14-00.png" alt=""></p>
<p>使用ajax技术在页面中发送请求到后台，apache.html</p>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script language-javascript">
    <span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span>onreadystatechange<span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span><span class="token string">'/file_list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span></code></pre>
<p>node：</p>
<pre class=" language-js"><code class="language-js">server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// url 属性返回请求的URL字符串</span>
    <span class="token keyword">var</span> urls <span class="token operator">=</span> request<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span> urls <span class="token operator">==</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./apache.html'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>html_data<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 设置响应头</span>
            response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将html中的内容响应回客户端，结束响应</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>urls <span class="token operator">==</span> <span class="token string">'/file_list'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>files<span class="token punctuation">)</span><span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'.'</span><span class="token operator">+</span>urls<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>html_data<span class="token punctuation">)</span><span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>apache.html –&gt; ajax</p>
<pre class=" language-js"><code class="language-js">xhr<span class="token punctuation">.</span>onreadystatechange<span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> data <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> htmls <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span><span class="token string">'&lt;tr>&lt;td valign="top">'</span><span class="token punctuation">;</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;img src="./img/layout.gif" alt="[   ]">&lt;/td>'</span><span class="token punctuation">;</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span><span class="token string">'&lt;td>&lt;a href="http://localhost/%e7%ac%94%e8%ae%b0-01.pdf">'</span><span class="token punctuation">;</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">'&lt;/a> &lt;/td>'</span><span class="token punctuation">;</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;td align="right">2018-04-26 10:31 &lt;/td>'</span><span class="token punctuation">;</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;td align="right">3.2M&lt;/td>&lt;td>&amp;nbsp;&lt;/td>&lt;/tr>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> tb <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'tbody'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        tb<span class="token punctuation">.</span>innerHTML<span class="token operator">+</span><span class="token operator">=</span>htmls<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="2-4-动态展示文件的其他属性"><a href="#2-4-动态展示文件的其他属性" class="headerlink" title="2.4 动态展示文件的其他属性"></a>2.4 动态展示文件的其他属性</h3><p>获取文件的其他属性：</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span><span class="token string">'utf8'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>files<span class="token punctuation">)</span><span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>er<span class="token punctuation">,</span>st<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>mtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>修改node代码</p>
<pre class=" language-js"><code class="language-js">server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// url 属性返回请求的URL字符串</span>
    <span class="token keyword">var</span> urls <span class="token operator">=</span> request<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>urls <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'./apache.html'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> html_data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 设置响应头</span>
            response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">// 将html中的内容响应回客户端，结束响应</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>urls <span class="token operator">==</span> <span class="token string">'/file_list'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// response.end(JSON.stringify(files));</span>
            <span class="token keyword">var</span> file_obj <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token comment" spellcheck="true">//  判断条件：声明一个变量，这个变量用来记录两个数据的中数据的长度</span>
            <span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                file_obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 利用自调用匿名函数，保留i的变量值</span>
                <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>er<span class="token punctuation">,</span> st<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        count <span class="token operator">++</span><span class="token punctuation">;</span>
                        file_obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>st<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                            file_obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'file'</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                            file_obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'dir'</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                        file_obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mtime <span class="token operator">=</span> st<span class="token punctuation">.</span>mtime<span class="token punctuation">;</span>
                        file_obj<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">=</span> st<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
                        <span class="token comment" spellcheck="true">// 当读取的文件个数与所有文件个数相等时</span>
                        <span class="token keyword">if</span><span class="token punctuation">(</span>count <span class="token operator">==</span> files<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
                            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>file_obj<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span>
                    <span class="token comment" spellcheck="true">// console.log(file_obj);</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment" spellcheck="true">// console.log(files[i]);</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'.'</span> <span class="token operator">+</span> urls<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> html_data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>修改 ajax代码</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> xhr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">XMLHttpRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span>onreadystatechange<span class="token operator">=</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>readyState <span class="token operator">==</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> data <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>responseText<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> htmls <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>data<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span><span class="token string">'&lt;tr>&lt;td valign="top">'</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">==</span> <span class="token string">'file'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                htmls<span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;img src="./img/layout.gif" alt="[   ]">&lt;/td>'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                htmls<span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;img src="./img/folder.gif" alt="[   ]">&lt;/td>'</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span><span class="token string">'&lt;td>&lt;a href="">'</span><span class="token punctuation">;</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token operator">+</span><span class="token string">'&lt;/a> &lt;/td>'</span><span class="token punctuation">;</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;td align="right">'</span><span class="token operator">+</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mtime <span class="token operator">+</span><span class="token string">'&lt;/td>'</span><span class="token punctuation">;</span>
            htmls<span class="token operator">+</span><span class="token operator">=</span> <span class="token string">'&lt;td align="right">'</span><span class="token operator">+</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">+</span><span class="token string">'&lt;/td>&lt;td>&amp;nbsp;&lt;/td>&lt;/tr>'</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">var</span> tb <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">'tbody'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        tb<span class="token punctuation">.</span>innerHTML<span class="token operator">+</span><span class="token operator">=</span>htmls<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
xhr<span class="token punctuation">.</span><span class="token function">open</span><span class="token punctuation">(</span><span class="token string">'get'</span><span class="token punctuation">,</span><span class="token string">'/file_list'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
xhr<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>循环后 i 丢失的问题：</p>
<pre class=" language-js"><code class="language-js">
<span class="token comment" spellcheck="true">// var arr = ['a', 'b', 'c'];</span>
<span class="token comment" spellcheck="true">// for (var i = 0; i &lt; arr.length; i++) {</span>
<span class="token comment" spellcheck="true">//     // 模拟延迟</span>
<span class="token comment" spellcheck="true">//     setTimeout(function () {</span>
<span class="token comment" spellcheck="true">//         console.log(arr[i]);</span>
<span class="token comment" spellcheck="true">//     }, 1000);</span>
<span class="token comment" spellcheck="true">// }</span>

<span class="token comment" spellcheck="true">/*
 * *******************************************
 * 上面的代码 全部输出 undefined
 * *******************************************
 */</span> 

<span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">,</span><span class="token string">'b'</span><span class="token punctuation">,</span><span class="token string">'c'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> arr<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 模拟延迟</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2 id="path模块"><a href="#path模块" class="headerlink" title="path模块"></a>path模块</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> str<span class="token operator">=</span><span class="token string">'/root/a/b/1.txt'</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 当前文件的上层目录
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 返回给定路径的最后一段
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">extname</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 返回当前文件扩展名，没则空

<span class="token comment" spellcheck="true">//console.log(path.resolve('/root/a/b', '../c', 'build', '..', 'strict'));</span>
<span class="token comment" spellcheck="true">//console.log(path.resolve(__dirname, 'build || 文件名'));</span>
给定的路径序列从右到左进行处理，每个后续的 path 前置，直到构造出一个绝对路径。 例如，给定的路径片段序列：<span class="token operator">/</span>foo、 <span class="token operator">/</span>bar、 baz，调用 path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'/foo'</span><span class="token punctuation">,</span> <span class="token string">'/bar'</span><span class="token punctuation">,</span> <span class="token string">'baz'</span><span class="token punctuation">)</span> 将返回 <span class="token operator">/</span>bar<span class="token operator">/</span>baz
</code></pre>
<h2 id="process模块"><a href="#process模块" class="headerlink" title="process模块"></a>process模块</h2><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> process<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//process能获取到本机的信息，方便于自动切换开发环境</span>

<span class="token keyword">let</span> mode<span class="token operator">=</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>OS<span class="token operator">==</span><span class="token string">'Windows_NT'</span><span class="token operator">?</span><span class="token string">'dev'</span><span class="token punctuation">:</span><span class="token string">'prod'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
  mode<span class="token punctuation">,</span>
  <span class="token operator">...</span><span class="token punctuation">(</span>mode<span class="token operator">==</span><span class="token string">'dev'</span><span class="token operator">?</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config.dev'</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./config.prod'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span></code></pre>
<h2 id="第3章-包管理器npm"><a href="#第3章-包管理器npm" class="headerlink" title="第3章 包管理器npm"></a>第3章 包管理器npm</h2><h3 id="3-1-使用moment"><a href="#3-1-使用moment" class="headerlink" title="3.1 使用moment"></a>3.1 使用moment</h3><p>使用第三方包格式化时间</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-26_13-42-13.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-26_13-43-05.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img%5CSnipaste_2018-09-26_13-44-02.png" alt=""></p>
<h3 id="3-2-npm-命令的使用"><a href="#3-2-npm-命令的使用" class="headerlink" title="3.2 npm 命令的使用"></a>3.2 npm 命令的使用</h3><p>上面的代码，我们使用npm安装了moment来进行格式化时间的处理，这就是使用第三方模块；</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-26_13-51-35.png" alt=""></p>
<p>而我们使用的npm就是node中自带的包(模块)管理工具；</p>
<p>借助NPM可以帮助我们快速安装和管理依赖包，使Node与第三方模块之间形成了一个良好的生态系统；</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-26_14-05-00.png" alt=""></p>
<p>我们也可以直接输入npm，查看帮助引导：</p>
<pre class=" language-shell"><code class="language-shell">PS C:\xamp\htdocs\ceshi\09> npm

Usage: npm <command>

where <command> is one of:
    access, adduser, audit, bin, bugs, c, cache, ci, cit,
    completion, config, create, ddp, dedupe, deprecate,
    dist-tag, docs, doctor, edit, explore, get, help,
    help-search, hook, i, init, install, install-test, it, link,
    list, ln, login, logout, ls, outdated, owner, pack, ping,
    prefix, profile, prune, publish, rb, rebuild, repo, restart,
    root, run, run-script, s, se, search, set, shrinkwrap, star,
    stars, start, stop, t, team, test, token, tst, un,
    uninstall, unpublish, unstar, up, update, v, version, view,
    whoami

npm <command> -h  quick help on <command>
npm -l            display full usage info
npm help <term>   search for help on <term>
npm help npm      involved overview

Specify configs in the ini-formatted file:
    C:\Users\Administrator\.npmrc
or on the command line via: npm <command> --key value
Config info can be viewed via: npm help config

npm@6.4.1 C:\Program Files\nodejs\node_modules\npm</code></pre>
<h3 id="3-3-使用npm初始化项目"><a href="#3-3-使用npm初始化项目" class="headerlink" title="3.3 使用npm初始化项目"></a>3.3 使用npm初始化项目</h3><p>一个项目，不可能只是使用一个第三方包，而包越多，管理起来就越麻烦，</p>
<p>而 npm init 给我们提供了项目初始化的功能，也解决了多个包的管理问题：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-26_14-38-00.png" alt=""></p>
<pre><code>&quot;name&quot;: &quot;usenpm&quot;, // 项目名
&quot;version&quot;: &quot;1.0.0&quot;, // 版本号
&quot;description&quot;: &quot;这是我们第一次使用npm&quot;,  // 描述信息
&quot;main&quot;: &quot;index.js&quot;, // 入口文件
&quot;scripts&quot;: { // npm 设置的一些指令
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
},
&quot;keywords&quot;: [ // 关键字
    &quot;第一次&quot;
],
&quot;author&quot;: &quot;itheima6期&quot;, // 作者
&quot;license&quot;: &quot;ISC&quot; // 当前项目的协议</code></pre><h3 id="补充-npm-install-几种方式-及-区别-s-和-d"><a href="#补充-npm-install-几种方式-及-区别-s-和-d" class="headerlink" title="补充 npm install 几种方式 及 区别 -s 和 -d"></a>补充 npm install 几种方式 及 区别 -s 和 -d</h3><p>“dependencies” : 依赖模块   -s<br>“devDependncies”: 开发环境  -d<br>npm install axios -s 表示安装到依赖模块</p>
<h3 id="3-4-解决-npm-被墙问题"><a href="#3-4-解决-npm-被墙问题" class="headerlink" title="3.4 解决 npm 被墙问题"></a>3.4 解决 npm 被墙问题</h3><p>npm 存储包文件的服务器在国外，有时候会被墙，速度很慢，所以我们需要解决这个问题。</p>
<p><a href="http://npm.taobao.org/" target="_blank" rel="noopener">http://npm.taobao.org/</a>  淘宝的开发团队把 npm 在国内做了一个备份。</p>
<p>安装淘宝的 cnpm：</p>
<pre class=" language-shell"><code class="language-shell"># 在任意目录执行都可以
# --global 表示安装到全局，而非当前目录
# --global 不能省略，否则不管用
npm install --global cnpm</code></pre>
<p>接下来你安装包的时候把之前的 <code>npm</code> 替换成 <code>cnpm</code>。</p>
<p>举个例子：</p>
<pre class=" language-shell"><code class="language-shell"># 这里还是走国外的 npm 服务器，速度比较慢
npm install jquery

# 使用 cnpm 就会通过淘宝的服务器来下载 jquery
cnpm install jquery</code></pre>
<p>如果不想安装 <code>cnpm</code> 又想使用淘宝的服务器来下载：</p>
<pre class=" language-shell"><code class="language-shell">npm install jquery --registry=https://registry.npm.taobao.org</code></pre>
<p>但是每一次手动这样加参数很麻烦，所我们可以把这个选项加入配置文件中：</p>
<pre class=" language-shell"><code class="language-shell"># 配置到淘宝服务器
npm config set registry https://registry.npm.taobao.org

# 查看 npm 配置信息
npm config list</code></pre>
<p>只要经过了上面命令的配置，则你以后所有的 <code>npm install</code> 都会默认通过淘宝的服务器来下载。</p>
<h3 id="3-5-package-json-与-package-lock-json-文件"><a href="#3-5-package-json-与-package-lock-json-文件" class="headerlink" title="3.5 package.json 与 package-lock.json 文件"></a>3.5 package.json 与 package-lock.json 文件</h3><p>如果后期开发过程中，需要项目迁移，我们只需要将package.json文件迁移即可，在新项目下执行</p>
<p><code>npm install</code> ，所有第三方包会自动安装；</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-26_14-44-19.png" alt=""></p>
<p>package.json的作用就是用来记录当前项目及包的使用情况；<code>不能在package.json中添加注释</code></p>
<p>package-lock.json  保存第三方包的版本和下载路径等详细信息；</p>
<p>当我们使用npm管理包时，package.json 及package-lock.json 的内容都会自动更新</p>
<h3 id="3-6-服务端页面渲染"><a href="#3-6-服务端页面渲染" class="headerlink" title="3.6 服务端页面渲染"></a>3.6 服务端页面渲染</h3><p>之前的案例中，我们时通过前端浏览器发送ajax请求获取服务器数据的，前端获取数据后进行遍历展示；</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-26_22-10-44.png" alt=""></p>
<p>缺点就是发送多次请求、不利于搜索引擎查找；我们修改改为后端渲染数据；</p>
<p>art-template：  <a href="https://www.npmjs.com/package/art-template" target="_blank" rel="noopener">https://www.npmjs.com/package/art-template</a></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> art <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'art-template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
art<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token string">'./'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token function">art</span><span class="token punctuation">(</span><span class="token string">'./art-test.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token number">123</span><span class="token punctuation">,</span>age<span class="token punctuation">:</span><span class="token number">345</span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token punctuation">{</span>a<span class="token punctuation">:</span><span class="token number">678</span><span class="token punctuation">,</span>b<span class="token punctuation">:</span><span class="token number">987</span><span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">></span></span>nihoa<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h2</span><span class="token punctuation">></span></span>{{data[0].name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h2</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
<p>1：重新创建目录，并初始化项目： <code>npm init</code></p>
<p>2：将之前写好的后台文件 http.js 和 前台模板页面 apache.html 复制到新项目目录中；</p>
<p>3：安装时间处理模块： <code>npm   install   moment</code></p>
<p>4：安装模板引擎模块:    <code>npm  install   art-template</code></p>
<p>5： 修改 后台文件 http.js 和 前台模板页面 apache.html  文件</p>
<p> http.js  ：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-26_20-56-03.png" alt=""></p>
<p>apache.html  ： </p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-26_20-57-11.png" alt=""></p>
<p>那么我们在项目中应该使用 客户端渲染还是服务端渲染：</p>
<p>答：两者都用，根据数据的不同作用而定；</p>
<blockquote>
<p>推举一个node开发时使用的小工具 nodemon</p>
<p>npm  install  nodemon  -g </p>
<p>安装成功后,使用 nodemon 运行代码,</p>
<p>代码一旦被保存,nodemon便会自动重新运行新代码</p>
</blockquote>
<h2 id="第4章-Node模块化及CommonJS规范"><a href="#第4章-Node模块化及CommonJS规范" class="headerlink" title="第4章 Node模块化及CommonJS规范"></a>第4章 Node模块化及CommonJS规范</h2><p>通过前面几个章节的学习, 我们基本掌握了NodeJS编程的基础知识, 但是我们也直观的发现了一个问题,和我们之前学习浏览器编程时JS, 差异还是很大的; 都是JavaScript编程, 为何有这种差异? 前面写过的防Apache服务器的案例中, 使用过内置fs模块, 使用过 moment 模块, 而这些模块都不是我们写的, 都是直接拿过来使用, 那么我们能不能自己写一个模块, 应该怎么写, 有哪些规矩, 如果我们自己写了一个模块, 能不能提供给其他编程人员直接使用, 应该怎么用? </p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-26_22-10-43.png" alt=""></p>
<blockquote>
<p>Electron  跨平台的桌面应用框架: <a href="https://electronjs.org/" target="_blank" rel="noopener">https://electronjs.org/</a></p>
</blockquote>
<h3 id="4-1-CommonJS规范的由来"><a href="#4-1-CommonJS规范的由来" class="headerlink" title="4.1 CommonJS规范的由来"></a>4.1 CommonJS规范的由来</h3><p>JS 的表现的表现能力取决于宿主环境提供的API, 在web1.0 时代, W3C 组织提供了浏览器的规范支持, 在web2.0 时代, 随着HTML5的发展, 更多的标准API 出现在了浏览器中, 但是, 在后端 JS 中标准的制定纹丝不动 ; </p>
<p>由 Mozilla 工程师Kevin Dangoor于2009年1月提出名为 <strong>ServerJS</strong> 的规范; 2009年8月，更名为<em>CommonJS，</em>以显示 API 的更广泛适用性。</p>
<blockquote>
<p>What I’m describing here is not a technical problem. It’s a matter of people getting together and making a decision to step forward and start building up something bigger and cooler together.      </p>
<p>我在这里描述的不是一个技术问题。这是一个人们聚在一起，决定向前一步，开始一起建立更大更酷的东西的问题。                                    </p>
<p>–Kevin Dangoor </p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-09-27_12-21-21.png" alt="深入浅出Node.js 图2-2"></p>
<h3 id="4-2-CommonJS-的模块规范"><a href="#4-2-CommonJS-的模块规范" class="headerlink" title="4.2 CommonJS 的模块规范"></a>4.2 CommonJS 的模块规范</h3><p>CommonJS对模块的定义十分简单，主要分为：</p>
<p>1、模块引用：</p>
<p>使用 <code>require()</code> 方法引入一个模块API ； </p>
<p>2、模块定义：</p>
<p>在模块中使用 exports 对象导出当前模块数据或方法；</p>
<p>在模块中还存在一个module对象，它代表模块自身，module对象有一个exports 属性，用于数据导出；</p>
<p> 其实exports 对象就是module.exports 的引用;   <code>exports === module.exports</code></p>
<p>3、模块标识：</p>
<p>其实就是模块的文件名，必须符合小驼峰法命名规则，使用<code>require()</code> 引入时使用 <code>. 或 ..</code> 开头的相对路径或绝对路径，引入时可以不写文件后缀名；</p>
<p><strong>重点注意</strong> ： 模块中的方法和变量的作用于尽在模块内部，每个模块具有独立的空间，互不干扰；</p>
<p>CommonJS 构建的模块机制中的引入与导出是我们完全不用考虑变量污染或者替换的问题，相比与<code>命名空间</code>的机制，简直就是天才和菜鸟的区别；</p>
<h3 id="4-3-Node对CommonJS的实现-Node模块化"><a href="#4-3-Node对CommonJS的实现-Node模块化" class="headerlink" title="4.3 Node对CommonJS的实现 (Node模块化)"></a>4.3 Node对CommonJS的实现 (Node模块化)</h3><p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-27_13-34-04.png" alt=""></p>
<p>以上代码就是<strong>自定义模块</strong>的基本规则  这是<strong>重点</strong></p>
<h3 id="4-4-模块加载的顺序和规则"><a href="#4-4-模块加载的顺序和规则" class="headerlink" title="4.4 模块加载的顺序和规则"></a>4.4 模块加载的顺序和规则</h3><p>在 CommonJS 规范中，使用 <code>require()</code> 加载(引入) 模块时，模块标识必须使用相对路径或绝对路径指明模块位置，但是在node的实现中，我们可以不指明模块路径；如： <code>require(&#39;fs&#39;)、require(&#39;moment&#39;)</code> ;</p>
<p>如果没有指明路径，那就是加载核心模块或第三方模块，指明加载路径一般就是加载自定义模块；</p>
<p>不管加载什么模块，都是优先从缓存中加载：</p>
<blockquote>
<p> Node 加载模块时，如果这个模块已经被加载过了，则会直接缓存起来，将来再次引用时不会再次加加载这个模块（即：如果一个模块被加载两次，则模块中的代码只会被执行一次）</p>
</blockquote>
<p>而核心模块和第三方模块的的加载顺序就是：</p>
<blockquote>
<p>先加载核心模块，核心模块的内容都是在安装node时已经编译好的可执行的二进制代码，加载执行的速度，仅次于缓存加载，如果核心模块中没有，则加载第三方模块</p>
</blockquote>
<p>第三方模块的加载规则：</p>
<blockquote>
<ul>
<li>先在当前文件的模块所属目录去找 node_modules目录</li>
<li>如果找到，则去该目录中找 模块名的目录  如 : moment </li>
<li>如果找到 moment 目录， 则找该目录中的 package.json文件</li>
<li>如果找到 package.json 文件，则找该文件中的 main属性</li>
<li>如果找到main 属性，则拿到该属性对应的文件</li>
<li>如果找到 moment 目录之后，<ul>
<li>没有package.json</li>
<li>或者有 package.json 没有 main 属性</li>
<li>或者有 main 属性，但是指向的路径不存在 </li>
<li>则 node 会默认去看一下 moment 目录中有没有 index.js –&gt; index.json–&gt; index.node 文件</li>
</ul>
</li>
<li>如果找不到index 或者 找不到 moment 或者找不到 node_modules </li>
<li>则进入上一级目录找 node_moudles 查找（规则同上）</li>
<li>如果上一级还找不到，继续向上，一直到当前文件所属磁盘的根目录</li>
<li>如果到磁盘概目录还没有找到，直接报错</li>
</ul>
</blockquote>
<h3 id="4-5-模块化封装案例"><a href="#4-5-模块化封装案例" class="headerlink" title="4.5 模块化封装案例"></a>4.5 模块化封装案例</h3><p>修改 http.js — 服务器模块</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> luyou <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./luyou'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

luyou<span class="token punctuation">.</span><span class="token function">server</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请访问 127.0.0.1:8000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p>添加自定义模块  luyou.js  – 路由模块 </p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> contrllor <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./contrllor'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">server</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> urls <span class="token operator">=</span> request<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>urls <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> html <span class="token operator">=</span> contrllor<span class="token punctuation">.</span>html<span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'.'</span> <span class="token operator">+</span> urls<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Type'</span><span class="token punctuation">,</span> <span class="token string">'text/html;charset=utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>

        <span class="token comment" spellcheck="true">// response.end('123');</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
exports<span class="token punctuation">.</span>server <span class="token operator">=</span> server<span class="token punctuation">;</span></code></pre>
<p>contrllor.js — 业务模块</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> moment <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'moment'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'art-template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
template<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token string">'./'</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">readdir</span><span class="token punctuation">(</span><span class="token string">'./'</span><span class="token punctuation">,</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> file_arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> cont <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> files<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        file_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// console.log(files[i]);</span>
        <span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">stat</span><span class="token punctuation">(</span>files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                cont<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 闭包  </span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    file_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'file'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    file_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'dir'</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                file_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name <span class="token operator">=</span> files<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
                file_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>size <span class="token operator">=</span> data<span class="token punctuation">.</span>size<span class="token punctuation">;</span>
                file_arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>mtime <span class="token operator">=</span> <span class="token function">moment</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>mtime<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">'YYYY-MM-DD hh:mm'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>cont <span class="token operator">==</span> files<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">var</span> html <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">'./apache.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span>file_arr<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    exports<span class="token punctuation">.</span>html <span class="token operator">=</span> html<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h2 id="第5章-用户管理系统–项目"><a href="#第5章-用户管理系统–项目" class="headerlink" title="第5章 用户管理系统–项目"></a>第5章 用户管理系统–项目</h2><h3 id="5-1-连接MySQL数据库"><a href="#5-1-连接MySQL数据库" class="headerlink" title="5.1 连接MySQL数据库"></a>5.1 连接MySQL数据库</h3><h4 id="5-1-1-mysql基本CURD"><a href="#5-1-1-mysql基本CURD" class="headerlink" title="5.1.1 mysql基本CURD"></a>5.1.1 mysql基本CURD</h4><pre class=" language-sql"><code class="language-sql"><span class="token keyword">SELECT</span> <span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> <span class="token number">1</span> 

<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span><span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">,</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">value</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token punctuation">[</span><span class="token keyword">value</span><span class="token operator">-</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token keyword">UPDATE</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token keyword">SET</span> <span class="token punctuation">`</span>name<span class="token punctuation">`</span><span class="token operator">=</span><span class="token string">'value'</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token number">1</span>

<span class="token keyword">DELETE</span> <span class="token keyword">FROM</span> <span class="token punctuation">`</span>users<span class="token punctuation">`</span> <span class="token keyword">WHERE</span> id<span class="token operator">=</span><span class="token keyword">value</span></code></pre>
<h4 id="5-1-2-安装连接MySQL"><a href="#5-1-2-安装连接MySQL" class="headerlink" title="5.1.2  安装连接MySQL"></a>5.1.2  安装连接MySQL</h4><p><code>npm install mysql</code></p>
<p>mysql.js :  </p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'onepiece'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 查找操作</span>
<span class="token keyword">var</span> select <span class="token operator">=</span> <span class="token string">'select * from users'</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>select<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">var</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>results<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 添加操作</span>
<span class="token keyword">var</span> ins <span class="token operator">=</span> <span class="token string">"INSERT INTO users (`name`, `nengli`, `jituan`, `img`) VALUES ('娜美', '雷电', '草帽海贼团', '')"</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>ins<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>err<span class="token punctuation">,</span>results<span class="token punctuation">,</span>field<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>results<span class="token punctuation">.</span>insertId<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="mysql-连接池"><a href="#mysql-连接池" class="headerlink" title="mysql 连接池"></a>mysql 连接池</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//连接池相比于上面的单次连接，更快速和更好管理，连接池可以设置并发连接数，一旦达到这个数，后续的连接只能等前面的连接执行完才能进行</span>
<span class="token keyword">var</span> Pool <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'onepiece'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//池选项</span>
<span class="token comment" spellcheck="true">//connectionLimit要同时创建的最大连接数。(默认：10)</span>
<span class="token comment" spellcheck="true">//queueLimit：  排队最大数  在返回错误之前，池将排队的最大连接请求数getConnection..如果设置为0，对排队的连接请求的数量没有限制。(0不做限制)</span></code></pre>
<h4 id="co-mysql-异步执行"><a href="#co-mysql-异步执行" class="headerlink" title="co-mysql  异步执行"></a>co-mysql  异步执行</h4><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//把所有mysql语句变为异步执行 可以使用 async\await  返回Promise对象</span>


<span class="token keyword">const</span> mysql<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> co<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co-mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>DB_HOST<span class="token punctuation">,</span> DB_PORT<span class="token punctuation">,</span> DB_USER<span class="token punctuation">,</span> DB_PASS<span class="token punctuation">,</span> DB_NAME<span class="token punctuation">}</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../config'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> conn<span class="token operator">=</span>mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host<span class="token punctuation">:</span> DB_HOST<span class="token punctuation">,</span>
  port<span class="token punctuation">:</span> DB_PORT<span class="token punctuation">,</span>
  user<span class="token punctuation">:</span> DB_USER<span class="token punctuation">,</span>
  password<span class="token punctuation">:</span> DB_PASS<span class="token punctuation">,</span>
  database<span class="token punctuation">:</span> DB_NAME
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token function">co</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// promise</span>
p<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT 1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//如：await db.query(`SELECT ID FROM user_table WHERE username='${username}'`);</span></code></pre>
<h3 id="5-2-项目初始化及安装第三方模块"><a href="#5-2-项目初始化及安装第三方模块" class="headerlink" title="5.2 项目初始化及安装第三方模块"></a>5.2 项目初始化及安装第三方模块</h3><p>新建目录 <code>haizei</code>  , 打开命令行执行 <code>npm init</code> 初始化项目;</p>
<p>一次性安装项目所需的所有模块;</p>
<p><code>npm install art-template mysql bootstrap jquery</code></p>
<h3 id="5-3-启动项目"><a href="#5-3-启动项目" class="headerlink" title="5.3 启动项目"></a>5.3 启动项目</h3><h4 id="5-3-1-创建http服务器并加载静态页面"><a href="#5-3-1-创建http服务器并加载静态页面" class="headerlink" title="5.3.1 创建http服务器并加载静态页面"></a>5.3.1 创建http服务器并加载静态页面</h4><p>http.js</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> http<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 加载路由模块</span>
<span class="token keyword">var</span> luyou <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./luyou'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

luyou<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8080'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'请打开浏览器访问 http://127.0.0.1:8080'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>luyou.js</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 引入业务模块使用模板引擎加载页面</span>
<span class="token keyword">var</span> yewu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./yewu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">.</span>bind <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> urls <span class="token operator">=</span> request<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>urls <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> data <span class="token operator">=</span> yewu<span class="token punctuation">.</span>html_data<span class="token punctuation">;</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'.'</span> <span class="token operator">+</span> urls<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p>yewu.js</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'art-template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
template<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token string">'./'</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> html_data <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span><span class="token number">123</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>html_data <span class="token operator">=</span> html_data<span class="token punctuation">;</span></code></pre>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-09-27_22-36-36.png" alt=""></p>
<h4 id="5-3-2-动态获取数据"><a href="#5-3-2-动态获取数据" class="headerlink" title="5.3.2 动态获取数据"></a>5.3.2 动态获取数据</h4><p>yewu.js</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> linkdb <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./linkdb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'art-template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
template<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token string">'./'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>linkdb<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> html_data <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span>linkdb<span class="token punctuation">.</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>html_data <span class="token operator">=</span> html_data<span class="token punctuation">;</span></code></pre>
<p>linkdb.js</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'onepiece'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"select * from users "</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>data<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span>data <span class="token operator">=</span> data
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>通过连接数据查找到的数据，对外导出时，导不出去，引入linkdb的业务模块，接不到数据；</p>
<p>关键：这个问题出现的原因很重；</p>
<h4 id="5-3-3-解决问题"><a href="#5-3-3-解决问题" class="headerlink" title="5.3.3 解决问题"></a>5.3.3 解决问题</h4><p>yewu.js</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> linkdb <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./linkdb'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'art-template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
template<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token string">'./'</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 使用linkdb模块导出的方法</span>
linkdb<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 利用回调函数获取数据</span>
    <span class="token keyword">var</span> html_data <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    exports<span class="token punctuation">.</span>html_data <span class="token operator">=</span> html_data<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>linkdb.js</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'onepiece'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
connection<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 将原来导出数据的方式改为导出方法，供模块加载者调用</span>
exports<span class="token punctuation">.</span>query <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"select * from users "</span><span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>data<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// console.log(data);</span>
        <span class="token comment" spellcheck="true">// 数据是通过回调函数的方式返回</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>根据模板引擎语法 修改静态页面 </p>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tbody</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tbody<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    {{each data}}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{$value.id}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{$value.name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{$value.nengli}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{$value.jituan}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>查看<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>修改<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
    {{/each}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tbody</span><span class="token punctuation">></span></span></code></pre>
<h3 id="5-4-获取单个用户信息"><a href="#5-4-获取单个用户信息" class="headerlink" title="5.4 获取单个用户信息"></a>5.4 获取单个用户信息</h3><h4 id="5-4-1-接受前台请求"><a href="#5-4-1-接受前台请求" class="headerlink" title="5.4.1 接受前台请求"></a>5.4.1 接受前台请求</h4><p>修改 luyou.js 路由模块，获取单个用户信息</p>
<pre class=" language-js"><code class="language-js">server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> urls <span class="token operator">=</span> request<span class="token punctuation">.</span>url<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>urls<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>urls <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> data <span class="token operator">=</span> yewu<span class="token punctuation">.</span>html_data<span class="token punctuation">;</span>
        response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>urls <span class="token operator">==</span> <span class="token string">'/getuser'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token string">'getsssss'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
        fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'.'</span> <span class="token operator">+</span> urls<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>但是，luyou模块，无法处理前台不同类型的请求, 需要我们在服务器端接受并处理客户端发送的 <strong>get 及 post</strong> 请求；</p>
<h4 id="5-4-2-获取请求类型及参数"><a href="#5-4-2-获取请求类型及参数" class="headerlink" title="5.4.2  获取请求类型及参数"></a>5.4.2  获取请求类型及参数</h4><p>GET 请求把所有的内容编码到访问路径中，POST  请求的内容全部都在请求体中。<br>http.ServerRequest   并没有一个属性内容为请求体，原因是等待请求体传输可能是一件<br>耗时的工作，譬如上传文件。而很多时候我们可能并不需要理会请求体的内容，恶意的 POST<br>请求会大大消耗服务器的资源。所以 Node.js  默认是不会解析请求体的，当我们需要的时候，<br>只能手动来做</p>
<blockquote>
<p>网络调试工具Postman，可以帮助我们发送各种HTTP请求，并接受服务器返回的数据；</p>
<p><a href="https://www.getpostman.com/" target="_blank" rel="noopener">https://www.getpostman.com/</a></p>
</blockquote>
<p><strong>获取请求类型</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取请求类型</span>
    <span class="token keyword">var</span> method <span class="token operator">=</span> request<span class="token punctuation">.</span>method<span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">;</span>
    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8000</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">' 请访问http://localhost:8000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p><strong>获取 GET 的请求参数</strong></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/Snipaste_2018-10-07_12-56-34.png" alt=""></p>
<p><strong>获取Post请求参数</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// url_obj = url.parse(request.url,true);</span>
        <span class="token comment" spellcheck="true">// console.log(url_obj.query); </span>

        <span class="token comment" spellcheck="true">//以上代码 无内容，失败</span>
        <span class="token comment" spellcheck="true">// POST请求的内容全部都在请求体中 </span>
<span class="token punctuation">}</span></code></pre>
<p>手册中明确说明：</p>
<p>为了支持各种可能的 HTTP 应用，Node.js 的 HTTP API 是非常底层的。 它只涉及流处理与消息解析。 它把一个消息解析成消息头和消息主体，但不解析具体的消息头或消息主体。</p>
<p>因此我们需要查找更底层的网络实现，node中的基础网络模块net模块： <a href="http://nodejs.cn/api/net.html：" target="_blank" rel="noopener">http://nodejs.cn/api/net.html：</a></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token string">"POST"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// url_obj = url.parse(request.url,true);</span>
    <span class="token comment" spellcheck="true">// console.log(url_obj.query); </span>

    <span class="token comment" spellcheck="true">//以上代码 无内容，失败</span>
    <span class="token comment" spellcheck="true">// POST请求的内容全部都在请求体中 </span>

    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// net 模块中的 net.Socket 提供的data及end事件 </span>
    <span class="token comment" spellcheck="true">// 绑定data事件获取数据</span>
    request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>che<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">+</span><span class="token operator">=</span> che<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment" spellcheck="true">// 绑定end事件，监听数据接受完成</span>
    request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// console.log(data);</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="5-5-获取单个用户信息"><a href="#5-5-获取单个用户信息" class="headerlink" title="5.5 获取单个用户信息"></a>5.5 获取单个用户信息</h3><p><strong>1： 修改路由逻辑，优先判断请求类型：</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 引入业务模块使用模板引擎加载页面</span>
<span class="token keyword">var</span> yewu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./yewu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>bind <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 优先判断请求方式</span>
        <span class="token keyword">var</span> method <span class="token operator">=</span> request<span class="token punctuation">.</span>method<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 解析URL参数</span>
        <span class="token keyword">var</span> url_obj <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// console.log(url_obj.query);//参数</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>pathname <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">var</span> data <span class="token operator">=</span> yewu<span class="token punctuation">.</span>html_data<span class="token punctuation">;</span>
                response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 判断 获取单个用户信息路由 </span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>pathname <span class="token operator">==</span> <span class="token string">'/getuser'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'.'</span> <span class="token operator">+</span> url_obj<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>2： 修改静态模板，添加查看连接</strong></p>
<pre class=" language-html"><code class="language-html"> <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/getuser?id<span class="token punctuation">=</span>{{$value.id}}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>查看<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>修改<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
     <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span></code></pre>
<p><strong>3：修改路由，获取get请求参数，并将id参数传入业务模块</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 判断 获取单个用户信息路由 </span>
<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>pathname <span class="token operator">==</span> <span class="token string">'/getuser'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取id参数</span>
    <span class="token keyword">var</span> id <span class="token operator">=</span> url_obj<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 在yewu模块中封装方法，传递id参数。</span>
    <span class="token comment" spellcheck="true">// 使用回掉函数获取数据</span>
    yewu<span class="token punctuation">.</span><span class="token function">gets</span><span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>4：修改业务模块，添加gets方法</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 封装gets方法并导出,接受id参数及回调函数</span>
exports<span class="token punctuation">.</span>gets <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 调用数据库模块的getone方法,并传入id参数</span>
    linkdb<span class="token punctuation">.</span><span class="token function">getone</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 利用回调函数获取数据</span>
        <span class="token keyword">var</span> user_data <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">'./users.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>5：添加users.html静态模板</strong></p>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    {{data[0].name}}
    {{data[0].nengli}}
    {{data[0].jituan}}
    {{data[0].name}}
    {{data[0].name}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
<p><strong>6：修改数据库模块，添加getone方法</strong></p>
<pre class=" language-js"><code class="language-js">exports<span class="token punctuation">.</span>getone <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"select * from users where id="</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// console.log(sql);</span>
    connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>data<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 数据是通过回调函数的方式返回</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// connection.end();</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>注意：将数据库模块中的所有 connection.end(); 删除，因为我们有多个方法，不能在方法调用中停止数据库的连接，否则，其他方法在后续调用中无法连接数据；</p>
</blockquote>
<h3 id="5-6-链式操作原理解析"><a href="#5-6-链式操作原理解析" class="headerlink" title="5.6 链式操作原理解析"></a>5.6 链式操作原理解析</h3><p><strong>链式操作的核心原理：</strong></p>
<p>test.js</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> c <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./chained1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// c.select();</span>
c<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id=2'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>chained.js</p>
<pre class=" language-js"><code class="language-js">module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    where<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>wh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>whe <span class="token operator">=</span> wh<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 链式操作的核心就是保存数据并返回本对象</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    select<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>whe <span class="token operator">==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"select * from users "</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"select * from users where "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>whe<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>whe <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    update<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>whe <span class="token operator">==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'更新数据时，请填写where条件'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"update xx from  set () where "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>whe<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>whe <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="5-7-使用链式操作灵活操作数据库"><a href="#5-7-使用链式操作灵活操作数据库" class="headerlink" title="5.7 使用链式操作灵活操作数据库"></a>5.7 使用链式操作灵活操作数据库</h3><p><strong>1：新建数据操作模块 db.js</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> mysql <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> connection <span class="token operator">=</span> mysql<span class="token punctuation">.</span><span class="token function">createConnection</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
    user<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
    password<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
    database<span class="token punctuation">:</span> <span class="token string">'onepiece'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    that<span class="token punctuation">:</span> <span class="token keyword">this</span><span class="token punctuation">,</span>
    where<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>wh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>whe <span class="token operator">=</span> wh<span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    select<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>whe <span class="token operator">==</span> undefined<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"select * from users "</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"select * from users where "</span> <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>whe<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment" spellcheck="true">// 用完后重置where条件，以免后续操作的数据重复</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>whe <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
        connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> results<span class="token punctuation">,</span> fields<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">callback</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>results<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>2：修改业务模块(yewu.js)的调用</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// var linkdb = require('./linkdb');</span>
<span class="token keyword">var</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> template <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'art-template'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
template<span class="token punctuation">.</span>defaults<span class="token punctuation">.</span>root <span class="token operator">=</span> <span class="token string">'./'</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    getall<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 利用回调函数获取数据</span>
            <span class="token keyword">var</span> html_data <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getone<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id='</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">var</span> user_data <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">'./users.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">callback</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span></code></pre>
<p><strong>3：修改路由模块(luyou.js)的调用</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> url <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'url'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// 引入业务模块使用模板引擎加载页面</span>
<span class="token keyword">var</span> yewu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./yewu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

exports<span class="token punctuation">.</span>bind <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>server<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    server<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'request'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 优先判断请求方式</span>
        <span class="token keyword">var</span> method <span class="token operator">=</span> request<span class="token punctuation">.</span>method<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 解析URL参数</span>
        <span class="token keyword">var</span> url_obj <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>url<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token string">'GET'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// console.log(url_obj.query);//参数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>pathname <span class="token operator">==</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                yewu<span class="token punctuation">.</span><span class="token function">getall</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>

            <span class="token comment" spellcheck="true">// 判断 获取单个用户信息路由 </span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>pathname <span class="token operator">==</span> <span class="token string">'/getuser'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 获取id参数</span>
                <span class="token keyword">var</span> id <span class="token operator">=</span> url_obj<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
                <span class="token comment" spellcheck="true">// 在yewu模块中封装方法，传递id参数。</span>
                <span class="token comment" spellcheck="true">// 使用回掉函数获取数据</span>
                yewu<span class="token punctuation">.</span><span class="token function">getone</span><span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
                    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span><span class="token string">'.'</span> <span class="token operator">+</span> url_obj<span class="token punctuation">.</span>pathname<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>error<span class="token punctuation">,</span> data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="5-8-修改用户信息"><a href="#5-8-修改用户信息" class="headerlink" title="5.8 修改用户信息"></a>5.8 修改用户信息</h3><h4 id="5-8-1-修改模板代码，添加链接"><a href="#5-8-1-修改模板代码，添加链接" class="headerlink" title="5.8.1 修改模板代码，添加链接"></a>5.8.1 修改模板代码，添加链接</h4><pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tbody</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tbody<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    {{each data}}
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{$value.id}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{$value.name}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{$value.nengli}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>{{$value.jituan}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/getuser?id<span class="token punctuation">=</span>{{$value.id}}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>查看<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/upuser?id<span class="token punctuation">=</span>{{$value.id}}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>修改<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>删除<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
    {{/each}}
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tbody</span><span class="token punctuation">></span></span></code></pre>
<h4 id="5-8-2-获取用户信息并填入表单"><a href="#5-8-2-获取用户信息并填入表单" class="headerlink" title="5.8.2 获取用户信息并填入表单"></a>5.8.2 获取用户信息并填入表单</h4><p><strong>1：添加路由判断(luyou.js)</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// 修改用户信息，先获取用户信息    </span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>pathname <span class="token operator">==</span> <span class="token string">'/upuser'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取id参数</span>
    <span class="token keyword">var</span> id <span class="token operator">=</span> url_obj<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 在yewu模块中封装方法，传递id参数。</span>
    <span class="token comment" spellcheck="true">// 使用回掉函数获取数据</span>
    yewu<span class="token punctuation">.</span><span class="token function">upuser_get</span><span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span></code></pre>
<p><strong>2：添加业务逻辑（yewu.js），获取用户信息</strong></p>
<pre class=" language-js"><code class="language-js">upuser_get<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>
    db<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id='</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> user_data <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">'./upuser.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>3：添加表单模板（upuser.html）</strong></p>
<pre class=" language-html"><code class="language-html"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">></span></span><span class="token style language-css">
    <span class="token selector">table </span><span class="token punctuation">{</span>
        <span class="token property">margin</span><span class="token punctuation">:</span> <span class="token number">0</span> auto<span class="token punctuation">;</span>
        <span class="token property">border-collapse</span><span class="token punctuation">:</span> collapse<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> <span class="token number">800</span>px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> <span class="token number">500</span>px<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token selector">td </span><span class="token punctuation">{</span>
        <span class="token property">border</span><span class="token punctuation">:</span> <span class="token number">1</span>px solid <span class="token hexcode">#ccc</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">></span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>/upuser?id<span class="token punctuation">=</span>{{data[0].id}}<span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>姓名<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>name<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{data[0].name}}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>能力<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>nengli<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{data[0].nengli}}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>团体<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
                    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>tuanti<span class="token punctuation">"</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>text<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>{{data[0].jituan}}<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span>上传图片<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>file<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">"</span>修改<span class="token punctuation">"</span></span><span class="token punctuation">></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">></span></span></code></pre>
<h4 id="5-8-3-获取并处理post提交数据，修改数据库"><a href="#5-8-3-获取并处理post提交数据，修改数据库" class="headerlink" title="5.8.3 获取并处理post提交数据，修改数据库"></a>5.8.3 获取并处理post提交数据，修改数据库</h4><p><strong>路由模块(luyou.js)</strong></p>
<pre class=" language-js"><code class="language-js"> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>method <span class="token operator">==</span> <span class="token string">'POST'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment" spellcheck="true">// 只要是POST请求，则优先获取数据</span>
     <span class="token comment" spellcheck="true">// 后处理路由逻辑</span>
     <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
     request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>che<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         data <span class="token operator">+</span><span class="token operator">=</span> che<span class="token punctuation">;</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>
     <span class="token comment" spellcheck="true">// 绑定end事件，监听数据接受完成</span>
     request<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment" spellcheck="true">// console.log(data);</span>
         <span class="token comment" spellcheck="true">// 获取Post传输的数据</span>
         <span class="token keyword">var</span> post_data <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment" spellcheck="true">// 路由判断</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>pathname <span class="token operator">==</span> <span class="token string">'/upuser'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token comment" spellcheck="true">// 调用业务层方法</span>
             yewu<span class="token punctuation">.</span><span class="token function">upuser_post</span><span class="token punctuation">(</span>url_obj<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">,</span> post_data<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                 response<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span><span class="token punctuation">)</span>

 <span class="token punctuation">}</span></code></pre>
<p><strong>业务模块（yewu.js）</strong></p>
<pre class=" language-js"><code class="language-js">upuser_post<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span>data<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 调用数据模块修改用户信息</span>
    db<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id='</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>changedRows<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// http服务器相应要求必须是字符串</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>changedRows<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<p><strong>数据库模块（db.js）</strong></p>
<pre class=" language-js"><code class="language-js">update<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 没where条件，则停止所有操作</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>where <span class="token operator">==</span> undefined<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment" spellcheck="true">// 拼接sql语句的set部分</span>
    <span class="token keyword">var</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>v <span class="token keyword">in</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">set</span> <span class="token operator">+</span><span class="token operator">=</span> v <span class="token operator">+</span><span class="token string">"='"</span><span class="token operator">+</span> data<span class="token punctuation">[</span>v<span class="token punctuation">]</span><span class="token operator">+</span><span class="token string">"',"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">var</span> sets <span class="token operator">=</span> <span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token keyword">set</span><span class="token punctuation">.</span>length<span class="token number">-1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> sql <span class="token operator">=</span> <span class="token string">"UPDATE `users` SET "</span><span class="token operator">+</span>sets <span class="token operator">+</span> <span class="token string">' where '</span><span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>whe<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// console.log(sql);</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>whe <span class="token operator">=</span> undefined<span class="token punctuation">;</span>
    connection<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>error<span class="token punctuation">,</span>res<span class="token punctuation">,</span>fields<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// console.log(error)</span>
        <span class="token comment" spellcheck="true">// 返回受影响行数</span>
        <span class="token function">callback</span><span class="token punctuation">(</span>res<span class="token punctuation">.</span>changedRows<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<blockquote>
<p>作业： 自己完成添加及删除操作</p>
</blockquote>
<h2 id="第7章-express-框架"><a href="#第7章-express-框架" class="headerlink" title="第7章 express 框架"></a>第7章 express 框架</h2><h3 id="7-1-简介"><a href="#7-1-简介" class="headerlink" title="7.1 简介"></a>7.1 简介</h3><p>Express 是基于  Node.js  平台，快速、开放、极简的 Web 开发框架, 提供一系列强大特性帮助你创建各种Web应用。Express 不对 node.js 已有的特性进行二次抽象，我们只是在它之上扩展了Web应用所需的功能。丰富的HTTP工具以及来自Connect框架的中间件随取随用，创建强健、友好的API变得快速又简单</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="/./img/Snipaste_2018-10-12_08-38-02.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_08-38-13.png" alt=""></p>
<h3 id="7-2-安装使用"><a href="#7-2-安装使用" class="headerlink" title="7.2 安装使用"></a>7.2 安装使用</h3><p>就像一个普通的第三方模块一样安装即可；</p>
<p><code>npm init</code>   <code>npm install express</code>  </p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'hello world !'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8000'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1：8000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>其中 <a href="http://www.expressjs.com.cn/4x/api.html" target="_blank" rel="noopener">Request、Response – API</a>   我们需要重点关注</p>
<h2 id="第8章-项目的重构"><a href="#第8章-项目的重构" class="headerlink" title="第8章 项目的重构"></a>第8章 项目的重构</h2><p>将我们之前的海贼王项目使用express框架进行重写，重写过程中，学习框架提供的各种API，并完善项目功能；</p>
<h3 id="8-1-启动服务器"><a href="#8-1-启动服务器" class="headerlink" title="8.1 启动服务器"></a>8.1 启动服务器</h3><p>创建http.js </p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8000'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1：8000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h3 id="8-2-重写路由模块"><a href="#8-2-重写路由模块" class="headerlink" title="8.2 重写路由模块"></a>8.2 重写路由模块</h3><p>之前我们写了一个独立的模块（luyou.js）来处理请求，而在 express 中已经帮我们写好了路由的请求处理规则，不需要我们进行判断；</p>
<p><strong><em>路由</em></strong> 是指确定应用程序如何响应对特定端点的客户端请求，该请求是URI（或路径）和特定HTTP请求方法（GET，POST等）。</p>
<p>每个路由都可以有一个或多个处理函数，这些函数在路由匹配时执行。</p>
<h4 id="8-2-1-express-中的基本路由"><a href="#8-2-1-express-中的基本路由" class="headerlink" title="8.2.1 express 中的基本路由"></a>8.2.1 express 中的基本路由</h4><p>路径定义采用以下结构：</p>
<pre class=" language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">method</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> handler<span class="token punctuation">)</span></code></pre>
<p>以下示例定义了简单路由。</p>
<p><code>Hello World!</code>在主页上回复：</p>
<pre class=" language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Hello World!'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>在根路由（<code>/</code>），应用程序的主页上响应POST请求：</p>
<pre class=" language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Got a POST request'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>响应对<code>/user</code>路由的PUT请求：</p>
<pre class=" language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Got a PUT request at /user'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>响应对<code>/user</code>路由的DELETE请求：</p>
<pre class=" language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token keyword">delete</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'Got a DELETE request at /user'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h4 id="8-2-2-外置路由"><a href="#8-2-2-外置路由" class="headerlink" title="8.2.2. 外置路由"></a>8.2.2. 外置路由</h4><p>设置 外置路由 rout.js </p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'123'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/edit'</span><span class="token punctuation">,</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'post_edit'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 导出 router</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span></code></pre>
<p>写好路由规则，一定要记得将 路由对象(router) 导出</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 引入外置路由</span>
<span class="token keyword">var</span> rout <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./rout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>rout<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 使用引入外置的路由</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8000'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1：8000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>将外置路由引入后，使用 app.use() 进行加载使用； </p>
<h4 id="8-2-3-使用外置路由修改项目"><a href="#8-2-3-使用外置路由修改项目" class="headerlink" title="8.2.3 使用外置路由修改项目"></a>8.2.3 使用外置路由修改项目</h4><p>在 luyou.js 中，注释以前的代码，添加新代码</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> yewu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./yewu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    yewu<span class="token punctuation">.</span><span class="token function">getall</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span></code></pre>
<p>在 http.js 中，使用 express 启动服务，并引入使用新修改的 luyou.js 模块</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> luyou <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./luyou'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>luyou<span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8080'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1:8080'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<p> <img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_11-03-13.png" alt=""></p>
<h4 id="8-2-4-使用链式操作添加路由"><a href="#8-2-4-使用链式操作添加路由" class="headerlink" title="8.2.4 使用链式操作添加路由"></a>8.2.4 使用链式操作添加路由</h4><p>luyou.js</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> yewu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./yewu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// express的路由支持链式操作</span>
router
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    yewu<span class="token punctuation">.</span><span class="token function">getall</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/getuser'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// req 提供了query属性获取请求参数</span>
    <span class="token keyword">var</span> id <span class="token operator">=</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// 在yewu模块中封装方法，传递id参数。</span>
    <span class="token comment" spellcheck="true">// 使用回掉函数获取数据</span>
    yewu<span class="token punctuation">.</span><span class="token function">getone</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span></code></pre>
<h4 id="8-2-5-优化路由模块"><a href="#8-2-5-优化路由模块" class="headerlink" title="8.2.5 优化路由模块"></a>8.2.5 优化路由模块</h4><p>路由模块 (luyou.js) 中只负责调用，调用时，将req  res 传入业务模块</p>
<pre class=" language-js"><code class="language-js">router
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    yewu<span class="token punctuation">.</span><span class="token function">getall</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// yewu.getall(function (data) {</span>
    <span class="token comment" spellcheck="true">//     res.end(data);</span>
    <span class="token comment" spellcheck="true">// })</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/getuser'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    yewu<span class="token punctuation">.</span><span class="token function">getone</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true">// req 提供了query属性获取请求参数</span>
    <span class="token comment" spellcheck="true">// var id = req.query.id;</span>
    <span class="token comment" spellcheck="true">// // 在yewu模块中封装方法，传递id参数。</span>
    <span class="token comment" spellcheck="true">// // 使用回掉函数获取数据</span>
    <span class="token comment" spellcheck="true">// yewu.getone(id, function (data) {</span>
    <span class="token comment" spellcheck="true">//     res.end(data);</span>
    <span class="token comment" spellcheck="true">// });</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>业务模块接受 req  res  负责处理请求并响应数据</p>
<pre class=" language-js"><code class="language-js">getall<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    db<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 利用回调函数获取数据</span>
        <span class="token keyword">var</span> html_data <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">'./index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// console.log(html_data);</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>html_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
getone<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    db<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id='</span><span class="token operator">+</span>req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">var</span> user_data <span class="token operator">=</span> <span class="token function">template</span><span class="token punctuation">(</span><span class="token string">'./users.html'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>data<span class="token punctuation">:</span>data<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>user_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
<p><strong>继续简化路由模块</strong></p>
<pre class=" language-js"><code class="language-js">router
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>getall<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/getuser'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>getone<span class="token punctuation">)</span></code></pre>
<p>原理：</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">fn</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> pros <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token operator">+</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">fn</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token function">pros</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// fn(pros);</span></code></pre>
<h3 id="8-3-重写模板引擎"><a href="#8-3-重写模板引擎" class="headerlink" title="8.3 重写模板引擎"></a>8.3 重写模板引擎</h3><p><a href="https://github.com/aui/art-template/issues/369" target="_blank" rel="noopener">art-template@4 新特性</a></p>
<p><a href="https://github.com/aui/express-art-template" target="_blank" rel="noopener">express-art-template</a> </p>
<p>安装：</p>
<pre class=" language-shell"><code class="language-shell">npm install --save art-template
npm install --save express-art-template</code></pre>
<p>官方示例：</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">engine</span><span class="token punctuation">(</span><span class="token string">'art'</span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express-art-template'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'view options'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    debug<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>NODE_ENV <span class="token operator">!==</span> <span class="token string">'production'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index.art'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
        user<span class="token punctuation">:</span> <span class="token punctuation">{</span>
            name<span class="token punctuation">:</span> <span class="token string">'aui'</span><span class="token punctuation">,</span>
            tags<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'art'</span><span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">,</span> <span class="token string">'nodejs'</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>修改 http.js 将 express-art-template 注册为express框架的模板引擎，并设置模板后缀为 html</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_13-52-28.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_13-54-53.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_14-03-20.png" alt=""></p>
<p>在项目中新建views目录，将所有静态页面放入views目录</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_14-05-30.png" alt=""></p>
<h3 id="8-4-利用-Express-托管静态文件"><a href="#8-4-利用-Express-托管静态文件" class="headerlink" title="8.4 利用 Express 托管静态文件"></a>8.4 利用 Express 托管静态文件</h3><p><a href="http://www.expressjs.com.cn/starter/static-files.html" target="_blank" rel="noopener">http://www.expressjs.com.cn/starter/static-files.html</a></p>
<p>在项目中新建 public 文件夹并将bootstrap.css移入， 修改 index.html 加载 css  静态文件 ，在http.js中引入并设置静态资源加载路径：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_14-25-19.png" alt=""></p>
<p>如果要使用多个静态资源目录，请多次调用 <code>express.static</code> 函数：</p>
<pre class=" language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p>访问静态资源文件时，<code>express.static</code> 函数会根据目录的添加顺序查找所需的文件。</p>
<h3 id="8-5-完成项目重构"><a href="#8-5-完成项目重构" class="headerlink" title="8.5 完成项目重构"></a>8.5 完成项目重构</h3><p>修改所有路由及业务模块代码</p>
<p>luyou.js</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> yewu <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./yewu'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>getall<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/getuser'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>getone<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/upuser'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>upuser_get<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upuser'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>upuser_post<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router<span class="token punctuation">;</span>
</code></pre>
<p>yewu.js</p>
<pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">// var linkdb = require('./linkdb');</span>
<span class="token keyword">var</span> db <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./db'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> querystring <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">// template.defaults.root = './';</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    getall<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    getone<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id='</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'./users.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    upuser_get<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id='</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'./upuser.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    upuser_post<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>che<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            data <span class="token operator">+</span><span class="token operator">=</span> che<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment" spellcheck="true">// 绑定end事件，监听数据接受完成</span>
        req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// console.log(data);</span>
            <span class="token comment" spellcheck="true">// 获取Post传输的数据</span>
            <span class="token keyword">var</span> post_data <span class="token operator">=</span> querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment" spellcheck="true">// 调用数据模块修改用户信息</span>
            db<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id='</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>post_data<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>changedRows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// http服务器相应要求必须是字符串</span>
                res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>changedRows<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="8-6-展示用户头像"><a href="#8-6-展示用户头像" class="headerlink" title="8.6 展示用户头像"></a>8.6 展示用户头像</h3><p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_14-57-04.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_14-57-40.png" alt=""></p>
<h3 id="8-7-修改用户头像"><a href="#8-7-修改用户头像" class="headerlink" title="8.7 修改用户头像"></a>8.7 修改用户头像</h3><h4 id="8-7-1-测试文件上传"><a href="#8-7-1-测试文件上传" class="headerlink" title="8.7.1 测试文件上传"></a>8.7.1 测试文件上传</h4><p>创建服务器：</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upfile'</span><span class="token punctuation">,</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> data <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>che<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        data <span class="token operator">+</span><span class="token operator">=</span> che<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 直接打印post传过来的数据</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8000'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1：8000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p>使用postman工具上传文件：</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_15-39-27.png" alt=""></p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_15-42-24.png" alt=""></p>
<h4 id="8-7-2-借助第三方插件处理文件上传"><a href="#8-7-2-借助第三方插件处理文件上传" class="headerlink" title="8.7.2 借助第三方插件处理文件上传"></a>8.7.2 借助第三方插件处理文件上传</h4><p><a href="https://www.npmjs.com/package/formidable" target="_blank" rel="noopener">https://www.npmjs.com/package/formidable</a></p>
<p>安装模块  <code>npm install formidable</code></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> formidable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'formidable'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upfile'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">formidable<span class="token punctuation">.</span>IncomingForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// form.uploadDir = './img'; // 设置上传路径</span>
    <span class="token comment" spellcheck="true">// form.keepExtensions = true; // 保留文件扩展名</span>

    form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> times <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 组装上传路径</span>
        <span class="token keyword">var</span> file_path <span class="token operator">=</span> <span class="token string">'./img/'</span><span class="token operator">+</span>times<span class="token operator">+</span>files<span class="token punctuation">.</span>imgs<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 将缓存文件移动至制定目录</span>
        fs<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span>imgs<span class="token punctuation">.</span>path<span class="token punctuation">,</span>file_path<span class="token punctuation">,</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>file_path<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8000'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1：8000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h4 id="8-7-3-在项目中实现文件上传"><a href="#8-7-3-在项目中实现文件上传" class="headerlink" title="8.7.3 在项目中实现文件上传"></a>8.7.3 在项目中实现文件上传</h4><p>修改 upuser.html</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_17-23-49.png" alt=""></p>
<p>修改业务模块 yewu.js 使用 formidable 获取 post 数据，实现文件上传 </p>
<pre class=" language-js"><code class="language-js">upuser_post<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">formidable<span class="token punctuation">.</span>IncomingForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> times <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 组装上传路径</span>
        <span class="token keyword">var</span> file_path <span class="token operator">=</span> <span class="token string">'./public/img/'</span> <span class="token operator">+</span> times <span class="token operator">+</span> files<span class="token punctuation">.</span>imgs<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// 将缓存文件移动至指定的public目录</span>
        fs<span class="token punctuation">.</span><span class="token function">rename</span><span class="token punctuation">(</span>files<span class="token punctuation">.</span>imgs<span class="token punctuation">.</span>path<span class="token punctuation">,</span> file_path<span class="token punctuation">,</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">// 因为设置静态资源时，已经时public文件夹，写入数据库时，不要加public</span>
                fields<span class="token punctuation">.</span>img <span class="token operator">=</span> <span class="token string">'./img/'</span> <span class="token operator">+</span> times <span class="token operator">+</span> files<span class="token punctuation">.</span>imgs<span class="token punctuation">.</span>name<span class="token punctuation">;</span>
                db<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string">'id='</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>query<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>fields<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>changedRows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment" spellcheck="true">// http服务器相应要求必须是字符串</span>
                    res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span>changedRows<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
                console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件上传失败'</span><span class="token operator">+</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="8-8-用户登陆"><a href="#8-8-用户登陆" class="headerlink" title="8.8 用户登陆"></a>8.8 用户登陆</h3><h4 id="8-8-1-登陆逻辑及cookie-session-的使用"><a href="#8-8-1-登陆逻辑及cookie-session-的使用" class="headerlink" title="8.8.1 登陆逻辑及cookie-session 的使用"></a>8.8.1 登陆逻辑及cookie-session 的使用</h4><p>express官方资源中，为我们提供了一个中间件，<a href="http://www.expressjs.com.cn/en/resources/middleware/cookie-session.html" target="_blank" rel="noopener">cookie-session</a> </p>
<p> <code>npm install cookie-session</code> </p>
<p>测试代码：</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cookieSession <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-session'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册中间件 </span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'session'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 客户端cookie的名称</span>
    keys<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'ss'</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 用于加密的关键字</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取并判断session</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>sess_data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'已经登陆'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果没有session,跳转到登陆页面</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;script>alert("没登陆");window.location.href="/up"&lt;/script>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/up'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 展示登陆页面，获取用户数据并写入session </span>
    req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>sess_data <span class="token operator">=</span> <span class="token punctuation">{</span>name<span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">,</span>age<span class="token punctuation">:</span><span class="token number">89</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'已写入session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="8-8-2-完成项目登陆功能"><a href="#8-8-2-完成项目登陆功能" class="headerlink" title="8.8.2 完成项目登陆功能"></a>8.8.2 完成项目登陆功能</h4><p><strong>修改http模块，注册 cookie-session 中间件；</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> cookieSession <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册中间件 </span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'session'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 客户端cookie的名称</span>
    keys<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'xilingzuishuai'</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 用于加密的关键字</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<p><strong>在业务模块 (yewu.js) 中 添加逻辑判断，只有登陆后才能展示首页：</strong></p>
<pre class=" language-js"><code class="language-js">getall<span class="token punctuation">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 获取并判断session</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>sess_data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        db<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> data <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// 如果没有session,跳转到登陆页面</span>
        res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;script>alert("没登陆");window.location.href="/upload"&lt;/script>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment" spellcheck="true">// res.send('没登陆');</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span></code></pre>
<p><strong>在路由模块(luyou.js) 中添加以下两个路由，get 展示静态登陆页面，post 获取用户提交的数据并写入 session ,写入成功后，跳转到首页；在业务模块(yewu.js)中添加响应的方法</strong></p>
<p><code>.get(&#39;/upload&#39;,yewu.upload_get)</code>  <code>.post(&#39;/upload&#39;,yewu.upload_post)</code></p>
<pre class=" language-js"><code class="language-js">upload_get<span class="token punctuation">:</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// 展示登陆页面</span>
    res<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'./upload.html'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>

upload_post<span class="token punctuation">:</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> form <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">formidable<span class="token punctuation">.</span>IncomingForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>err<span class="token punctuation">,</span> fields<span class="token punctuation">,</span> files<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// console.log(fields);</span>
        <span class="token comment" spellcheck="true">// 获取用户提交数据，判断用户名密码是否正确</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>fields<span class="token punctuation">.</span>userName <span class="token operator">==</span> <span class="token string">"admin"</span> <span class="token operator">&amp;&amp;</span> fields<span class="token punctuation">.</span>pwd <span class="token operator">==</span> <span class="token string">"123"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 数据正确，写入session</span>
            req<span class="token punctuation">.</span>session<span class="token punctuation">.</span>sess_data <span class="token operator">=</span> fields<span class="token punctuation">;</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;script>alert("登陆成功");window.location.href="/"&lt;/script>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
            <span class="token comment" spellcheck="true">// 数据错误，重新跳回登陆页面</span>
            res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'&lt;script>alert("登陆失败");window.location.href="/upload"&lt;/script>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span></code></pre>
<h3 id="express另外附加使用技巧"><a href="#express另外附加使用技巧" class="headerlink" title="express另外附加使用技巧"></a>express另外附加使用技巧</h3><ol>
<li>处理get数据，使用express自带的req.query()</li>
<li>处理post数据，除了原生自带的，还可以借助第三方模块body-parser(在第三方模块中有介绍)，作为中间加工步骤来处理post请求</li>
<li>处理文件请求，原生处理起来比较乏力，借助第三方可以快速便捷，如：formidable 在以上案例（用户头像中有介绍使用，文件请求和字段都可以一并处理）、multiparty(在第三方模块中有介绍,同样文件请求和字段都可以一并处理)、multer（在第三方模块中有介绍）只能处理文件，可以做为中间件使用</li>
<li>cookie和seesion，可以使用第三方模块cookie-session（在用户登录中有介绍）、cookie-parser（在第三方模块中有介绍） 专门用来处理cookie,可以用来加密cookie，以上都可以作为中间件使用</li>
</ol>
<h2 id="第9章-Express的中间件"><a href="#第9章-Express的中间件" class="headerlink" title="第9章 Express的中间件"></a>第9章 Express的中间件</h2><h3 id="9-1-什么是中间件"><a href="#9-1-什么是中间件" class="headerlink" title="9.1 什么是中间件"></a>9.1 什么是中间件</h3><p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="./img/Snipaste_2018-10-12_22-08-40.png" alt=""></p>
<p>在一个整体的流程中的某个环节，因为某些原因加入了额外的处理环节；</p>
<h3 id="9-2-中间件的使用"><a href="#9-2-中间件的使用" class="headerlink" title="9.2    中间件的使用"></a>9.2    中间件的使用</h3><h4 id="9-2-1-应用中间件"><a href="#9-2-1-应用中间件" class="headerlink" title="9.2.1 应用中间件"></a>9.2.1 应用中间件</h4><p>语法：</p>
<blockquote>
<ul>
<li><p>app.use()</p>
<ul>
<li><p>app.use(function(){}) </p>
<p>无论发送任何请求都会执行的中间件</p>
</li>
<li><p>app.use(‘/path’, function(){})</p>
<p>只要在请求path路由时才会执行的中间件（无论GET/POST）</p>
</li>
</ul>
</li>
<li><p>app.method()</p>
<ul>
<li><p>app.get()</p>
<p>在get请求时会执行的中间件</p>
</li>
<li><p>app.post()</p>
<p>在post请求时会执行的中间件</p>
</li>
</ul>
</li>
</ul>
</blockquote>
<p><strong>app.use() 的用法</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 在中间件之前，不受中间件影响</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 应用中间件</span>
<span class="token comment" spellcheck="true">// 请求 '/user' 时，会先调用中间件</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 调用之前先调用中间件</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8000'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1：8000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<p><strong>app.method() 的用法</strong></p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 在中间件之前，不受中间件影响</span>
app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// 应用中间件</span>
<span class="token comment" spellcheck="true">// 只有在 post 请求user 时才起作用</span>
app<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span><span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 调用之前先调用中间件</span>
<span class="token comment" spellcheck="true">// 接受所有请求方式请求user</span>
app<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span>res<span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token string">'8000'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'127.0.0.1：8000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span></code></pre>
<h4 id="9-2-2-路由中间件"><a href="#9-2-2-路由中间件" class="headerlink" title="9.2.2 路由中间件"></a>9.2.2 路由中间件</h4><p>路由器层中间件的工作方式与应用层中间件基本相同，差异之处在于它绑定到 <code>express.Router()</code> 的实例。</p>
<p>使用 <code>router.use()</code> 和 <code>router.METHOD()</code> 函数装入路由器层中间件；</p>
<p>我们之前项目的代码，就是在使用路由中间件：</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> router <span class="token operator">=</span> express<span class="token punctuation">.</span><span class="token function">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>getall<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/getuser'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>getone<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/upuser'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>upuser_get<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upuser'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>upuser_post<span class="token punctuation">)</span>

<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>upload_get<span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/upload'</span><span class="token punctuation">,</span>yewu<span class="token punctuation">.</span>upload_post<span class="token punctuation">)</span>
<span class="token punctuation">;</span></code></pre>
<h4 id="9-2-3-内置中间件"><a href="#9-2-3-内置中间件" class="headerlink" title="9.2.3 内置中间件"></a>9.2.3 内置中间件</h4><p> 除 <code>express.static</code> 外，先前 Express 随附的所有中间件函数现在以单独模块的形式提供：<a href="https://github.com/senchalabs/connect#middleware" target="_blank" rel="noopener">中间件函数的列表</a></p>
<p>Express 中唯一内置的中间件函数是 <code>express.static</code>。此函数基于 <a href="https://github.com/expressjs/serve-static" target="_blank" rel="noopener">serve-static</a>，负责提供 Express 应用程序的静态资源。</p>
<p>对于每个应用程序，可以有多个静态目录：</p>
<pre class=" language-javascript"><code class="language-javascript">app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'uploads'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>express<span class="token punctuation">.</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'files'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h4 id="9-2-4-第三方中间件"><a href="#9-2-4-第三方中间件" class="headerlink" title="9.2.4 第三方中间件"></a>9.2.4 第三方中间件</h4><p>使用第三方中间件向 Express 应用程序添加功能。</p>
<p>安装具有所需功能的 Node.js 模块，然后在应用层或路由器层的应用程序中将其加装入。</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">var</span> cookieSession <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// 注册中间件 </span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieSession</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    name<span class="token punctuation">:</span> <span class="token string">'session'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 客户端cookie的名称</span>
    keys<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'xilingzuishuai'</span><span class="token punctuation">]</span> <span class="token comment" spellcheck="true">// 用于加密的关键字</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h2 id="第10章-Koa-框架"><a href="#第10章-Koa-框架" class="headerlink" title="第10章 Koa 框架"></a>第10章 Koa 框架</h2><blockquote>
<p>Koa框架是express原帮人马打造，小且精干，express有的Koa都有，甚至比express还更有优势，如：在express中回调是必不可少的，语法大多停止在ES5版本，而Koa则使用generator、async等新特性解决了回调套回调，语法上也紧跟ECMAScript版本，是当下流行的框架</p>
</blockquote>
<h3 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h3><p>1.安装 koa框架</p>
<p>npm   init    </p>
<p>npm install koa </p>
<p>提示：在express中路由自带，koa中没有自带路由，需自行下载（koa-router）</p>
<h3 id="嵌套路由："><a href="#嵌套路由：" class="headerlink" title="嵌套路由："></a>嵌套路由：</h3><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//加载koa</span>
<span class="token keyword">const</span> Router<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//加载koa路由框架</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//在koa中可以嵌套路由</span>
<span class="token keyword">let</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//最顶级</span>
UserRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//用户路由</span>

    <span class="token comment" spellcheck="true">//用户路由中子路由</span>
 HomeRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
 AdminRouter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//路由函数有两个参数 一个是ctx上下文（什么都有） next中间函数（可以省略）</span>
<span class="token comment" spellcheck="true">//函数前都加async,使用next也同样要加await</span>
HomeRouter<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/a'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'前台用户'</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'前台用户'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
AdminRouter<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/a'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'后台用户'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'后台用户'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

UserRouter<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">async</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span>next<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'用户模块'</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'User'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//用户路由添加两个子路由</span>
UserRouter<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/home'</span><span class="token punctuation">,</span>HomeRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
UserRouter<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/admin'</span><span class="token punctuation">,</span>AdminRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment" spellcheck="true">//最顶级的路由添加用户路由作为子路由</span>
router<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span>UserRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//最后添加到服务器上</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">/*
当前嵌套路由层级
router=> 
        UserRouter => HomeRouter
                     AdminRouter
*/</span>
<span class="token comment" spellcheck="true">//上面是把路由写在一个文件，正常情况是分开写然后引入</span></code></pre>
<h3 id="嵌套路由（分开版）图片展示："><a href="#嵌套路由（分开版）图片展示：" class="headerlink" title="嵌套路由（分开版）图片展示："></a>嵌套路由（分开版）图片展示：</h3><p>1.服务器页面（总页面）</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/koa1.PNG" alt=""></p>
<p>2.路由文件：router/user/index.js</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/koa5.PNG" alt=""></p>
<p>3.路由目录</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/koa2.PNG" alt=""></p>
<p>4.子路由页面</p>
<p> 4.1 admin</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/koa3.PNG" alt=""></p>
<p>4.2 company</p>
<p><img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog_images/images/koa4.PNG" alt=""></p>
<p><strong>提示：可以在总页面上添加和user同级的多个路由</strong></p>
<h3 id="路由传参："><a href="#路由传参：" class="headerlink" title="路由传参："></a>路由传参：</h3><p><strong>koa路由传参新方式</strong>（也可以使用旧方式）</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> Koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> router<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//路由传参   :字段 想传多少传多少 </span>
<span class="token comment" spellcheck="true">//也可以  ?字段=值方式传值，只不过获取方式不同</span>
router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/news/:id/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>

  <span class="token keyword">let</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span><span class="token operator">=</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">// :字段方式传参的数据在ctx.params中</span>

<span class="token comment" spellcheck="true">//启动后，访问/news/34 id就是34</span>
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">'新闻id='</span><span class="token operator">+</span>id<span class="token punctuation">;</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/news/1/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> ctx<span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span><span class="token operator">=</span>ctx<span class="token punctuation">.</span>params<span class="token punctuation">;</span>

  ctx<span class="token punctuation">.</span>body<span class="token operator">+</span><span class="token operator">=</span><span class="token string">'aaa'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//当定义的函数像以上情况有点混淆的时候，谁在前，谁先执行，和express一样从上往下执行</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment" spellcheck="true">/*
用?id=xxx传参和/:id有什么区别？倾向于用/:id吗？

urlencoded      http://aaa.com/user?a=12&amp;b=5
params          http://aaa.com/user/12/5

    urlencoded      params
    顺序灵活         死的
    可省略           死的
    不利于SEO        利于SEO
*/</span>
</code></pre>
<h3 id="ctx对象属性介绍"><a href="#ctx对象属性介绍" class="headerlink" title="ctx对象属性介绍"></a>ctx对象属性介绍</h3><pre class=" language-js"><code class="language-js">
ctx<span class="token punctuation">.</span>params  <span class="token comment" spellcheck="true">//获取路由 ：字段方式的数据</span>
ctx<span class="token punctuation">.</span>query    <span class="token comment" spellcheck="true">//获取路由 ？字段 = 值 方式的数据</span>
ctx<span class="token punctuation">.</span>method <span class="token comment" spellcheck="true">//请求方式</span>
ctx<span class="token punctuation">.</span>url<span class="token comment" spellcheck="true">//请求地址url</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>

server<span class="token punctuation">.</span>context：<span class="token comment" spellcheck="true">// 相当于ctx的prototype</span>

server<span class="token punctuation">.</span>coconst Koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span>context<span class="token punctuation">.</span>a<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//在ctx原型添加属性</span>
<span class="token keyword">let</span> router<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/news/'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> ctx<span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> <span class="token punctuation">{</span>id<span class="token punctuation">}</span><span class="token operator">=</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">'bbb'</span><span class="token operator">+</span>ctx<span class="token punctuation">.</span>a<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//实例里获取</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>

ctx<span class="token punctuation">.</span>request <span class="token comment" spellcheck="true">//请求</span>
ctx<span class="token punctuation">.</span>response<span class="token comment" spellcheck="true">//响应</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>

ctx<span class="token punctuation">.</span>path        <span class="token comment" spellcheck="true">//路径</span>
ctx<span class="token punctuation">.</span>ip         <span class="token comment" spellcheck="true">// 客户端的IP</span>

ctx<span class="token punctuation">.</span>headers     <span class="token comment" spellcheck="true">//请求头</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>

ctx<span class="token punctuation">.</span><span class="token keyword">throw</span><span class="token punctuation">(</span>code<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>   
ctx<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span>条件<span class="token punctuation">,</span> code<span class="token punctuation">,</span> msg<span class="token punctuation">)</span>

ctx<span class="token punctuation">.</span><span class="token keyword">throw</span><span class="token punctuation">(</span><span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'username is required'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 ctx<span class="token punctuation">.</span><span class="token function">assert</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>query<span class="token punctuation">.</span>pass<span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">,</span> <span class="token string">'password is required'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//一旦触发，会把错误信息响应到客户端</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>

ctx<span class="token punctuation">.</span>state<span class="token operator">=</span><span class="token number">305</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//状态码</span>
ctx<span class="token punctuation">.</span><span class="token function">redirect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//重定向</span>
ctx<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//下载文件</span></code></pre>
<h3 id="koa-static管理静态文件"><a href="#koa-static管理静态文件" class="headerlink" title="koa-static管理静态文件"></a>koa-static管理静态文件</h3><p>koa-static 需自行下载，不自带</p>
<pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> Koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">static</span><span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-static'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> router<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/user'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> ctx<span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//可以配合koa-router使用</span>
<span class="token keyword">let</span> staticRouter<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
staticRouter<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token regex">/(\.jpg|\.png|\.gif)$/i</span><span class="token punctuation">,</span> <span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'./static'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  maxage<span class="token punctuation">:</span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">1000</span> <span class="token comment" spellcheck="true">//静态文件缓存时间  这里2个月</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
staticRouter<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token regex">/(\.css)$/i</span><span class="token punctuation">,</span> <span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'./static'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  maxage<span class="token punctuation">:</span> <span class="token number">1</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">1000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
staticRouter<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token regex">/(\.html|\.htm|\.shtml)$/i</span><span class="token punctuation">,</span> <span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'./static'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  maxage<span class="token punctuation">:</span> <span class="token number">20</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">1000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
staticRouter<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">,</span> <span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'./static'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  maxage<span class="token punctuation">:</span> <span class="token number">30</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">1000</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//加载static中间件</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>staticRouter<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//类似express的方式</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//指定文件</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">static</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    index<span class="token punctuation">:</span><span class="token string">'index.html'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span></code></pre>
<h3 id="koa-better-body处理post请求和文件请求（可以一并处理，需自行下载）"><a href="#koa-better-body处理post请求和文件请求（可以一并处理，需自行下载）" class="headerlink" title="koa-better-body处理post请求和文件请求（可以一并处理，需自行下载）"></a>koa-better-body处理post请求和文件请求（可以一并处理，需自行下载）</h3><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> Koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> body<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-better-body'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  uploadDir<span class="token punctuation">:</span> <span class="token string">'./static/upload'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> ctx<span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">//文件和post数据</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>fields<span class="token punctuation">)</span><span class="token punctuation">;</span>

  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">'aaa'</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="koa中的-cookie、session"><a href="#koa中的-cookie、session" class="headerlink" title="koa中的 cookie、session"></a>koa中的 cookie、session</h3><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//在koa中cookie自带，session则没有，需要下载一个叫：koa-session模块</span>

<span class="token comment" spellcheck="true">//----------cookie  注意：如果在设置cookie的时候设置了签名，获取的时候也要开签名  (signed) 否则被串改，服务器获取的数据将会是被串改的</span>
server<span class="token punctuation">.</span>keys <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'sadasdasdasdasdvvvvvvvvvsadasdasd'</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">//设置cookie签名的循环密匙</span>
<span class="token comment" spellcheck="true">//设置和获取cookie在ctx上下文对象中</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span>
ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span><span class="token string">'xuyuxin'</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
    signed<span class="token punctuation">:</span><span class="token boolean">true</span>  <span class="token comment" spellcheck="true">//开启签名 </span>
    <span class="token comment" spellcheck="true">//cookie中可以设置的属性，在这就可以设置如：domain、maxAge</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

 console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'user'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>signed<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//---------------------session</span>
<span class="token keyword">const</span> Koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> session<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-session'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span>keys<span class="token operator">=</span><span class="token punctuation">[</span>    <span class="token comment" spellcheck="true">//跟cookie相同</span>
  <span class="token string">'asdfasdfasdfasdfasdf'</span><span class="token punctuation">,</span>
  <span class="token string">'hghjfgjghjkyggfytyurt'</span><span class="token punctuation">,</span>
  <span class="token string">'hjghjkfguig8ygyi8t78i8'</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">session</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  maxAge<span class="token punctuation">:</span> <span class="token number">20</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">,</span>   <span class="token comment" spellcheck="true">//有效期</span>
  renew<span class="token punctuation">:</span> <span class="token boolean">true</span>           <span class="token comment" spellcheck="true">//自动续期</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> server<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> ctx<span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'view'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'view'</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span>session<span class="token punctuation">[</span><span class="token string">'view'</span><span class="token punctuation">]</span><span class="token operator">++</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token template-string"><span class="token string">`欢迎你第</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>view<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">次来访`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="koa中的mysql"><a href="#koa中的mysql" class="headerlink" title="koa中的mysql"></a>koa中的mysql</h3><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//一般在koa中，会把常用的模块或中间件放在 ctx.prototype(server.context)中，以便在任何地方使用</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">-</span>database<span class="token punctuation">.</span>js
<span class="token keyword">const</span> mysql<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> co<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co-mysql'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> conn<span class="token operator">=</span>mysql<span class="token punctuation">.</span><span class="token function">createPool</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  host<span class="token punctuation">:</span> <span class="token string">'localhost'</span><span class="token punctuation">,</span>
  user<span class="token punctuation">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span>
  password<span class="token punctuation">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  database<span class="token punctuation">:</span> <span class="token string">'20181101'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> db<span class="token operator">=</span><span class="token function">co</span><span class="token punctuation">(</span>conn<span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports<span class="token operator">=</span>db<span class="token punctuation">;</span>

<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>引入
<span class="token keyword">const</span> Koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span>context<span class="token punctuation">.</span>db<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./libs/database'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//引入后，就可在ctx中使用</span>
server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span><span class="token keyword">async</span> ctx<span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
   <span class="token keyword">let</span> data <span class="token operator">=</span>  <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>db<span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token string">'SELECT * FROM tbale'</span><span class="token punctuation">)</span>；
   ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> JSON<span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="在koa中如何处理错误"><a href="#在koa中如何处理错误" class="headerlink" title="在koa中如何处理错误"></a>在koa中如何处理错误</h3><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> Koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Router<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-router'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//以中间件方式处理</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">'错了'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//也可以用Router方式处理  * 代表全部，只要请求就会触发</span>
<span class="token keyword">let</span> router<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> ctx<span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span>body<span class="token operator">=</span><span class="token string">'错了-router'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

router<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/a'</span><span class="token punctuation">,</span> <span class="token keyword">async</span> ctx<span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body<span class="token operator">=</span>div<span class="token punctuation">.</span>title<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="koa-ejs模板引擎"><a href="#koa-ejs模板引擎" class="headerlink" title="koa-ejs模板引擎"></a>koa-ejs模板引擎</h3><p> <a href="https://ejs.bootcss.com/" target="_blank" rel="noopener">ejs 文档</a></p>
<pre class=" language-ejs"><code class="language-ejs"><% if (user) { %>
 <%= user.name %>
<% } %>

用法
var template = ejs.compile(str, options);
template(data);
// => 输出绘制后的 HTML 字符串

ejs.render(str, data, options);
// => 输出绘制后的 HTML 字符串

ejs.renderFile(filename, data, options, function(err, str){
    // str => 输出绘制后的 HTML 字符串
});


你可能需要能够输出原始内容的标签 (<%-) 用于 include 指令，避免对输出的 HTML 代码做转义处理。

<ul>
  <% users.forEach(function(user){ %>
    <%- include('user/show', {user: user}); %>
  <% }); %>
</ul>

自定义分隔符
可针对单个模板或全局使用自定义分隔符：

var ejs = require('ejs'),
    users = ['geddy', 'neil', 'alex'];

// 单个模板文件
ejs.render('<?= users.join(" | "); ?>', {users: users},
    {delimiter: '?'});
// => 'geddy | neil | alex'

// 全局
ejs.delimiter = '$';
ejs.render('<$= users.join(" | "); $>', {users: users});
// => 'geddy | neil | alex'

//语法大多跟js一样</code></pre>
<ul>
<li><p>参数<br>cache 缓存编译后的函数，需要提供 filename<br>filename 被 cache 参数用做键值，同时也用于 include 语句<br>context 函数执行时的上下文环境<br>compileDebug 当为 false 时不编译调试语句<br>client 返回独立的编译后的函数<br>delimiter 放在角括号中的字符，用于标记标签的开与闭<br>debug 将生成的函数体输出<br>_with 是否使用 with() {} 结构。如果为 false，所有局部数据将存储在 locals 对象上。<br>localsName 如果不使用 with ，localsName 将作为存储局部变量的对象的名称。默认名称是 locals<br>rmWhitespace 删除所有可安全删除的空白字符，包括开始与结尾处的空格。对于所有标签来说，它提供了一个更安全版本的 -%&gt; (在一行的中间并不会剔除标签后面的换行符)。<br>escape 为 &lt;%= 结构设置对应的转义（escape）函数。它被用于输出结果以及在生成的客户端函数中通过 .toString() 输出。(默认转义 XML)。</p>
</li>
<li><p>标签含义<br>&lt;% ‘脚本’ 标签，用于流程控制，无输出。<br>&lt;%_ 删除其前面的空格符<br>&lt;%= 输出数据到模板（输出是转义 HTML 标签）<br>&lt;%- 输出非转义的数据到模板<br>&lt;%# 注释标签，不执行、不输出内容<br>&lt;%% 输出字符串 ‘&lt;%’<br>%&gt; 一般结束标签<br>-%&gt; 删除紧随其后的换行符<br>_%&gt; 将结束标签后面的空格符删除<br>包含（include）<br>通过 include 指令将相对于模板路径中的模板片段包含进来。(需要提供 ‘filename’ 参数。) 例如，如果存在 “./views/users.ejs” 和 “./views/user/show.ejs” 两个模板文件，你可以通过 &lt;%- include(‘user/show’); %&gt; 代码包含后者。</p>
</li>
</ul>
<h4 id="在koa中使用"><a href="#在koa中使用" class="headerlink" title="在koa中使用"></a>在koa中使用</h4><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> Koa<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> ejs<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-ejs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> path<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//语法</span>
<span class="token function">ejs</span><span class="token punctuation">(</span>server<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  root<span class="token punctuation">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'template'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//根路径  文件夹名称</span>
  layout<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//模板在根目录中是否要再封装一个文件夹， 是的话写对应的文件名，否则放在根目录指定位置 默认是 true 自动在根目录加上一层文件夹 </span>
  viewExt<span class="token punctuation">:</span> <span class="token string">'ejs'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//模板后缀</span>
  cache<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true">//是否缓存</span>
  debug<span class="token punctuation">:</span> <span class="token boolean">false</span> <span class="token comment" spellcheck="true">// 是否将渲染好文件展示</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2 id="附加章-第三方模块"><a href="#附加章-第三方模块" class="headerlink" title="附加章 第三方模块"></a>附加章 第三方模块</h2><h3 id="forever：node启动器-，发生错误时也会重启，挂在后台"><a href="#forever：node启动器-，发生错误时也会重启，挂在后台" class="headerlink" title="forever：node启动器 ，发生错误时也会重启，挂在后台"></a>forever：node启动器 ，发生错误时也会重启，挂在后台</h3><pre class=" language-js"><code class="language-js">npm i forever <span class="token operator">-</span>g  npm安装

<span class="token comment" spellcheck="true">//语法</span>
forever start xxx<span class="token punctuation">.</span>js   开启
forever restart xxx<span class="token punctuation">.</span>js 重启
forever stop xxx<span class="token punctuation">.</span>js  停止
forever stopall  停止全部

forever start xxx<span class="token punctuation">.</span>js <span class="token operator">-</span>l c<span class="token punctuation">:</span><span class="token operator">/</span>a<span class="token punctuation">.</span>log <span class="token operator">-</span>e c<span class="token punctuation">:</span><span class="token operator">/</span>err<span class="token punctuation">.</span>log <span class="token operator">-</span>a 
</code></pre>
<h3 id="body-parser：用来处理post数据的模块之一"><a href="#body-parser：用来处理post数据的模块之一" class="headerlink" title="body-parser：用来处理post数据的模块之一"></a>body-parser：用来处理post数据的模块之一</h3><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> express<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> body<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//在express中作为中间件使用</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  extended<span class="token punctuation">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//最后在req的body中</span>
server<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/reg'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//注意，此模块不能处理上传文件请求</span>

<span class="token comment" spellcheck="true">//用原生node封装一个类似body-parser的简易版</span>
<span class="token keyword">const</span> express<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> querystring<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//跟以上相同</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> arr<span class="token operator">=</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> buffer<span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  req<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    <span class="token keyword">let</span> post<span class="token operator">=</span>querystring<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>Buffer<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>arr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    req<span class="token punctuation">.</span>body<span class="token operator">=</span>post<span class="token punctuation">;</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/reg'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//把以上的中间件函数封装</span>
<span class="token keyword">const</span> express<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> body<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./libs/body-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>body<span class="token punctuation">.</span><span class="token function">urlencoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/reg'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//即可自己实现一个简易的中间件</span></code></pre>
<h3 id="multiparty：处理post中文件上传请求和字段请求（可以一并处理也可单一）"><a href="#multiparty：处理post中文件上传请求和字段请求（可以一并处理也可单一）" class="headerlink" title="multiparty：处理post中文件上传请求和字段请求（可以一并处理也可单一）"></a>multiparty：处理post中文件上传请求和字段请求（可以一并处理也可单一）</h3><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> http<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> multiparty<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multiparty'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  <span class="token keyword">let</span> form<span class="token operator">=</span><span class="token keyword">new</span> <span class="token class-name">multiparty<span class="token punctuation">.</span>Form</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    uploadDir<span class="token punctuation">:</span> <span class="token string">'./upload'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  form<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">;</span>

  form<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'field'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'字段：'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  form<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'file'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>name<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'文件：'</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> file<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  form<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'表单解析完成'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//请求到响应，中间如果出错，就算文件已经上传成功也会被删除</span></code></pre>
<h3 id="multer：专门用来处理文件的模块，其他不行"><a href="#multer：专门用来处理文件的模块，其他不行" class="headerlink" title="multer：专门用来处理文件的模块，其他不行"></a>multer：专门用来处理文件的模块，其他不行</h3><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> express<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> multer<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'multer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//作为中间件使用</span>
<span class="token keyword">let</span> obj<span class="token operator">=</span><span class="token function">multer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>dest<span class="token punctuation">:</span> <span class="token string">'./static/upload'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>obj<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//最后处理完的数据存在req的files中</span>
server<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">'/reg'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>files<span class="token punctuation">)</span><span class="token punctuation">;</span>

  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'upload successed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="cookie-parser-专门处理cookie的模块"><a href="#cookie-parser-专门处理cookie的模块" class="headerlink" title="cookie-parser:专门处理cookie的模块"></a>cookie-parser:专门处理cookie的模块</h3><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> express<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> cookieParser<span class="token operator">=</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'cookie-parser'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">let</span> server<span class="token operator">=</span><span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8080</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//签名加密</span>
server<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">cookieParser</span><span class="token punctuation">(</span>
  <span class="token string">'fasdgfhsrtyredfbfd56te5645sdter76tytutyi456ythgfgerrhdfghfdg'</span>
<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/a'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">></span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'cookie:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>cookies<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token comment" spellcheck="true">//未签名的</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'signed:'</span><span class="token punctuation">,</span> req<span class="token punctuation">.</span>signedCookies<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment" spellcheck="true">//签名的</span>


  res<span class="token punctuation">.</span><span class="token function">cookie</span><span class="token punctuation">(</span><span class="token string">'amount'</span><span class="token punctuation">,</span> <span class="token number">99.8</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//httpOnly: true,   是否只能在服务端使用</span>
    maxAge<span class="token punctuation">:</span> <span class="token number">14</span><span class="token operator">*</span><span class="token number">86400</span><span class="token operator">*</span><span class="token number">1000</span><span class="token punctuation">,</span>
    <span class="token comment" spellcheck="true">//secure: true,         只有https</span>
    signed<span class="token punctuation">:</span> <span class="token boolean">true</span>     <span class="token comment" spellcheck="true">//是否启用签名</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


  res<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token string">'ok'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="uuid生成唯一标识符"><a href="#uuid生成唯一标识符" class="headerlink" title="uuid生成唯一标识符"></a>uuid生成唯一标识符</h3><pre class=" language-js"><code class="language-js"><span class="token comment" spellcheck="true">//注意：此模块不能使用require('uuid')直接引入，uuid有很多个版本，因此直接引入会出错，需要指定对应版本引入 require('uuid/[v1|v3|v4|v5]')</span>

版本<span class="token number">1</span>（时间戳）：

<span class="token keyword">const</span>  uuidv1  <span class="token operator">=</span>  require（<span class="token string">' uuid / v1 '</span>）<span class="token punctuation">;</span>
uuidv1（）<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ⇨'2c5ea4c0-4067-11e9-8bad-9b1deb4d3b7d'</span>
版本<span class="token number">3</span>（命名空间）：

<span class="token keyword">const</span>  uuidv3  <span class="token operator">=</span>  require（<span class="token string">' uuid / v3 '</span>）<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ...使用预定义的DNS命名空间（域名）</span>
uuidv3（ <span class="token string">' hello.example.com '</span>， uuidv3。 DNS）<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ⇨'9125a8dc-52ee-365b-a5aa-81b0b3681cf6'</span>

<span class="token comment" spellcheck="true">// ...使用预定义的URL命名空间（，好了，URL）的</span>
uuidv3（ <span class="token string">' http://example.com/hello '</span>， uuidv3。网址）<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ⇨'c6235813-3ba4-3801-ae84-e0a6ebb7d138'</span>

<span class="token comment" spellcheck="true">// ...使用自定义名称空间</span>
<span class="token comment" spellcheck="true">// // </span>
<span class="token comment" spellcheck="true">//注意：自定义名称空间应为特定于您的应用程序的UUID字符串！</span>
<span class="token comment" spellcheck="true">//例如，这里的一个是使用uuid CLI模块生成的。</span>
<span class="token keyword">const</span>  MY_NAMESPACE  <span class="token operator">=</span>  <span class="token string">' 1b671a64-40d5-491e-99b0-da01ff1f3341 '</span> <span class="token punctuation">;</span>
uuidv3（ <span class="token string">' Hello，World！'</span>， MY_NAMESPACE）<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ⇨'e8b5a51d-11c8-3310-a6ab-367563f20686'</span>
版本<span class="token number">4</span>（随机）：

<span class="token keyword">const</span>  uuidv4  <span class="token operator">=</span>  require（<span class="token string">' uuid / v4 '</span>）<span class="token punctuation">;</span>
uuidv4（）<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ⇨'1b9d6bcd-bbfd-4b2d-9b5d-ab8dfbbd4bed'</span>
版本<span class="token number">5</span>（命名空间）：

<span class="token keyword">const</span>  uuidv5  <span class="token operator">=</span>  require（<span class="token string">' uuid / v5 '</span>）<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ...使用预定义的DNS命名空间（域名）</span>
uuidv5（ <span class="token string">' hello.example.com '</span>， uuidv5。 DNS）<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ⇨'fdda765f-fc57-5604-a269-52a7df8164ec'</span>

<span class="token comment" spellcheck="true">// ...使用预定义的URL命名空间（，好了，URL）的</span>
uuidv5（ <span class="token string">' http://example.com/hello '</span>， uuidv5。网址）<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ⇨'3bbcee75-cecc-5b56-8031-b6641c1ed1f1'</span>

<span class="token comment" spellcheck="true">// ...使用自定义名称空间</span>
<span class="token comment" spellcheck="true">// // </span>
<span class="token comment" spellcheck="true">//注意：自定义名称空间应为特定于您的应用程序的UUID字符串！</span>
<span class="token comment" spellcheck="true">//例如，这里的一个是使用uuid CLI模块生成的。</span>
<span class="token keyword">const</span>  MY_NAMESPACE  <span class="token operator">=</span>  <span class="token string">' 1b671a64-40d5-491e-99b0-da01ff1f3341 '</span> <span class="token punctuation">;</span>
uuidv5（ <span class="token string">' Hello，World！'</span>， MY_NAMESPACE）<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// ⇨'630eb68f-e0fa-5ecc-887a-7c7a62614681'</span></code></pre>
<h3 id="jsonwebtoken-检验-生成token"><a href="#jsonwebtoken-检验-生成token" class="headerlink" title="jsonwebtoken 检验/生成token"></a>jsonwebtoken 检验/生成token</h3><pre class=" language-js"><code class="language-js"><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> Token <span class="token operator">=</span> <span class="token punctuation">{</span>
  encrypt<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span>time<span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token comment" spellcheck="true">//data加密数据，time过期时间</span>
    <span class="token keyword">return</span> jwt<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token string">'token'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>expiresIn<span class="token punctuation">:</span>time<span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  decrypt<span class="token punctuation">:</span><span class="token keyword">function</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> data <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token string">'token'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        token<span class="token punctuation">:</span><span class="token boolean">true</span><span class="token punctuation">,</span>
        id<span class="token punctuation">:</span>data<span class="token punctuation">.</span>id
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        token<span class="token punctuation">:</span><span class="token boolean">false</span><span class="token punctuation">,</span>
        data<span class="token punctuation">:</span>e
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> Token<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//1. 首先安装jsonwebtoken  </span>

npm install jsonwebtoken

<span class="token comment" spellcheck="true">//2. 引入jsonwebtoken</span>

<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jsonwebtoken'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//3. encrypt加密函数</span>

<span class="token comment" spellcheck="true">//jsonwebtoken提供了一个函数sign用于加密生成jwt,格式jwt.sign(data,str,options)</span>

<span class="token comment" spellcheck="true">//参数data 表示要加密的数据</span>

<span class="token comment" spellcheck="true">//参数str 自定义字符串，这个字符串在解密时需要用到，在这里我随便写了一个‘token’。这相当于一个密钥secret，服务器端需要妥善保管。</span>

<span class="token comment" spellcheck="true">//参数options 其他内容，可以设置令牌有效时间{expiresIn:time}。time的取值，'15d'表示15天,'2h'表示2小时，……</span>

<span class="token comment" spellcheck="true">//4.decrypt解密函数</span>

<span class="token comment" spellcheck="true">//jsonwebtoken提供了一个函数verify用于解密jwt,格式jwt.verify(token,str)</span>

<span class="token comment" spellcheck="true">//参数token 表示需要解密的令牌 </span>

<span class="token comment" spellcheck="true">//参数str 表示加密时用到的自定义字符串，即密钥</span>

<span class="token comment" spellcheck="true">//5.用法</span>

<span class="token keyword">const</span> Token <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'../utils/token'</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//code……</span>

<span class="token keyword">const</span> token <span class="token operator">=</span> Token<span class="token punctuation">.</span><span class="token function">encrypt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>id<span class="token punctuation">:</span>user<span class="token punctuation">.</span>id<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token string">'15d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//将user.id加密，设置有效期15天，返回token</span>

<span class="token comment" spellcheck="true">//code……</span>


<span class="token comment" spellcheck="true">//解密</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> Token<span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>header<span class="token punctuation">.</span>authorization<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">//将请求头的token取出解密</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>token<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//有效token</span>
<span class="token punctuation">}</span><span class="token keyword">else</span><span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">//无效token</span>
<span class="token punctuation">}</span>
</code></pre>
<blockquote>
<p>本文档大量参考相关书籍、文档、博客、手册等资源，最终解释权归 <a href="https://zhuanlan.zhihu.com/xilinglaoshi" target="_blank" rel="noopener"><strong>西岭老湿</strong></a> 个人所有；</p>
<p>参考资源相关列表:</p>
<p><a href="https://nodejs.org/zh-cn/" target="_blank" rel="noopener">https://nodejs.org/zh-cn/</a>   node.js官网 </p>
<p><a href="http://nodejs.cn/" target="_blank" rel="noopener">http://nodejs.cn/</a>  node.js中文网 </p>
<p>《深入浅出Node.js》  朴灵著 ，人民邮电出版社</p>
<p><a href="https://en.wikipedia.org/wiki/CommonJS" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/CommonJS</a>  维基百科 </p>
<p><a href="http://es6.ruanyifeng.com/" target="_blank" rel="noopener">《ECMAScript 6 入门》(第三版)</a>  阮一峰著 ，电子工业出版社</p>
<p>《你不知道的JavaScript》(上、中、下卷)   [美] Kyle Simpson 著 ，人民邮电出版社</p>
<p><a href="http://www.expressjs.com.cn/" target="_blank" rel="noopener">http://www.expressjs.com.cn/</a>   express中文网</p>
</blockquote>

            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.jinghong.ml" rel="external nofollow noreferrer">Jing Hong</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://www.jinghong.ml/posts/decd.html">https://www.jinghong.ml/posts/decd.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="https://www.jinghong.ml" target="_blank">Jing Hong</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/JavaScript/">
                                    <span class="chip bg-color">JavaScript</span>
                                </a>
                            
                                <a href="/tags/Node/">
                                    <span class="chip bg-color">Node</span>
                                </a>
                            
                                <a href="/tags/express/">
                                    <span class="chip bg-color">express</span>
                                </a>
                            
                                <a href="/tags/Koa/">
                                    <span class="chip bg-color">Koa</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/share/css/share.min.css">

<div id="article-share">
    
    
    <div class="social-share" data-sites="qq,qzone,wechat,weibo,douban" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    
        <style>
    .valine-card {
        margin: 1.5rem auto;
    }

    .valine-card .card-content {
        padding: 20px 20px 5px 20px;
    }

    #vcomments textarea {
        box-sizing: border-box;
        background: url("/medias/comment_bg.png") 100% 100% no-repeat;
    }

    #vcomments p {
        margin: 2px 2px 10px;
        font-size: 1.05rem;
        line-height: 1.78rem;
    }

    #vcomments blockquote p {
        text-indent: 0.2rem;
    }

    #vcomments a {
        padding: 0 2px;
        color: #4cbf30;
        font-weight: 500;
        text-decoration: none;
    }

    #vcomments img {
        max-width: 100%;
        height: auto;
        cursor: pointer;
    }

    #vcomments ol li {
        list-style-type: decimal;
    }

    #vcomments ol,
    ul {
        display: block;
        padding-left: 2em;
        word-spacing: 0.05rem;
    }

    #vcomments ul li,
    ol li {
        display: list-item;
        line-height: 1.8rem;
        font-size: 1rem;
    }

    #vcomments ul li {
        list-style-type: disc;
    }

    #vcomments ul ul li {
        list-style-type: circle;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    #vcomments table, th, td {
        border: 0;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments h1 {
        font-size: 1.85rem;
        font-weight: bold;
        line-height: 2.2rem;
    }

    #vcomments h2 {
        font-size: 1.65rem;
        font-weight: bold;
        line-height: 1.9rem;
    }

    #vcomments h3 {
        font-size: 1.45rem;
        font-weight: bold;
        line-height: 1.7rem;
    }

    #vcomments h4 {
        font-size: 1.25rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    #vcomments h5 {
        font-size: 1.1rem;
        font-weight: bold;
        line-height: 1.4rem;
    }

    #vcomments h6 {
        font-size: 1rem;
        line-height: 1.3rem;
    }

    #vcomments p {
        font-size: 1rem;
        line-height: 1.5rem;
    }

    #vcomments hr {
        margin: 12px 0;
        border: 0;
        border-top: 1px solid #ccc;
    }

    #vcomments blockquote {
        margin: 15px 0;
        border-left: 5px solid #42b983;
        padding: 1rem 0.8rem 0.3rem 0.8rem;
        color: #666;
        background-color: rgba(66, 185, 131, .1);
    }

    #vcomments pre {
        font-family: monospace, monospace;
        padding: 1.2em;
        margin: .5em 0;
        background: #272822;
        overflow: auto;
        border-radius: 0.3em;
        tab-size: 4;
    }

    #vcomments code {
        font-family: monospace, monospace;
        padding: 1px 3px;
        font-size: 0.92rem;
        color: #e96900;
        background-color: #f8f8f8;
        border-radius: 2px;
    }

    #vcomments pre code {
        font-family: monospace, monospace;
        padding: 0;
        color: #e8eaf6;
        background-color: #272822;
    }

    #vcomments pre[class*="language-"] {
        padding: 1.2em;
        margin: .5em 0;
    }

    #vcomments code[class*="language-"],
    pre[class*="language-"] {
        color: #e8eaf6;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }

    #vcomments b,
    strong {
        font-weight: bold;
    }

    #vcomments dfn {
        font-style: italic;
    }

    #vcomments small {
        font-size: 85%;
    }

    #vcomments cite {
        font-style: normal;
    }

    #vcomments mark {
        background-color: #fcf8e3;
        padding: .2em;
    }

    #vcomments table, th, td {
        padding: 12px 13px;
        border: 1px solid #dfe2e5;
    }

    table tr:nth-child(2n), thead {
        background-color: #fafafa;
    }

    #vcomments table th {
        background-color: #f2f2f2;
        min-width: 80px;
    }

    #vcomments table td {
        min-width: 80px;
    }

    #vcomments [type="checkbox"]:not(:checked), [type="checkbox"]:checked {
        position: inherit;
        margin-left: -1.3rem;
        margin-right: 0.4rem;
        margin-top: -1px;
        vertical-align: middle;
        left: unset;
        visibility: visible;
    }
</style>

<div class="card valine-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="vcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/valine/av-min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/valine/Valine.min.js"></script>
<script>
    new Valine({
        el: '#vcomments',
        appId: 'J9sh9ev0bWNYJHXJ259oelol-gzGzoHsz',
        appKey: 'dMAddMTzSDSVxKvVOG0sLLdM',
        notify: 'true' === 'true',
        verify: 'true' === 'true',
        visitor: 'true' === 'true',
        avatar: '/medias/avatar.jpg',
        pageSize: '10',
        lang: 'zh-cn',
        placeholder: 'just go go'
    });
</script>

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/posts/ab06.html">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog/medias/featureimages/22.jpg" class="responsive-img" alt="Vue">
                        
                        <span class="card-title">Vue</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Vue.js第 0 章 Vue 介绍0.0 开发工程发展历史
通过前面的介绍，我们对目前的项目工程化有了大体了了解，那么其中，在第二阶段的工程化演进中，有一个重要的工程设计理念诞生，他就是著名的 MVC 设计模式，简单点，MVC 其实就是为
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2019-11-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Front/" class="post-category">
                                    Front
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JavaScript/">
                        <span class="chip bg-color">JavaScript</span>
                    </a>
                    
                    <a href="/tags/Vue/">
                        <span class="chip bg-color">Vue</span>
                    </a>
                    
                    <a href="/tags/Vuex/">
                        <span class="chip bg-color">Vuex</span>
                    </a>
                    
                    <a href="/tags/VueRouter/">
                        <span class="chip bg-color">VueRouter</span>
                    </a>
                    
                    <a href="/tags/vue-cli/">
                        <span class="chip bg-color">vue-cli</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/posts/7c26.html">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/loading.gif" data-original="https://cdn.jsdelivr.net/gh/JingHong0202/blog/medias/featureimages/16.jpg" class="responsive-img" alt="Canvas">
                        
                        <span class="card-title">Canvas</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            Canvas
canvas 是HTML5新出的标签，可以用来做小游戏，特效，作图等，自己并没有作画能力，只能通过Javascript脚本来操控

Canvas标准http://www.w3c.org/TR/2dcontext/https:/
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2019-09-17
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/Front/" class="post-category">
                                    Front
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/JavaScript/">
                        <span class="chip bg-color">JavaScript</span>
                    </a>
                    
                    <a href="/tags/Canvas/">
                        <span class="chip bg-color">Canvas</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('120')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Jing Hong<br />'
            + '文章作者: Jing Hong<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/codeBlock/codeShrink.js"></script>


<!-- 代码块折行 -->


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>



    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            <span id="year">2020</span>
            <a href="https://www.jinghong.ml" target="_blank">Jing Hong</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/jinghong0202" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50" >
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:979892455@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50" >
        <i class="fas fa-envelope-open"></i>
    </a>



    <a href="https://gitee.com/jinghong0919" class="tooltipped" target="_blank" data-tooltip="访问我的Gitee" data-position="top" data-delay="50" >
        Gitee
    </a>

 


    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=979892455" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 979892455"  data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>





    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/js/search.js"></script>
<script type="text/javascript">
$(function () {
    searchFunc("https://cdn.jsdelivr.net/gh/JingHong0202/blog/" + "search.xml", 'searchInput', 'searchResult');
});
</script>
    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>

    <script>
        window.onload = () => {
           var load = document.querySelector('.load-mask')
           load.ontransitionend = () => {
               load.style.display = 'none'
           }
           load.style.opacity = 0;
           
        }
    </script>
    <script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/js/matery.js"></script>
    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas> 
    <script type="text/javascript" src="https://cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script> 
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/jinghong0202/blog@master/js/fireworks.js" async="async"></script>
    <script type="text/javascript">window.$crisp=[];window.CRISP_WEBSITE_ID="3d25ddec-0e9c-42aa-bfba-ce5a824b727d";(function(){d=document;s=d.createElement("script");s.src="https://client.crisp.chat/l.js";s.async=1;d.getElementsByTagName("head")[0].appendChild(s);})();</script>
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <!-- Baidu Analytics -->

<script>
    var _hmt = _hmt || [];
    (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?0de9b11510dfcd04b3ec5da35ab10447";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    

    

    

    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/background/ribbon-dynamic.js" async="async"></script>
    
    
    
    <script src="https://cdn.jsdelivr.net/gh/JingHong0202/blog/libs/instantpage/instantpage.js" type="module"></script>
    
    <script type="text/javascript" >
        //只在桌面版网页启用特效
        var windowWidth = $(window).width();
        if (windowWidth > 768) {
            document.write('<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/jinghong0202/blog/js/sakura.js" async="async" ><\/script><script src="https://cdn.jsdelivr.net/gh/jinghong0202/live2d-widget/autoload.js" async="async"><\/script>');
        }
    </script>
    
<script>!function(e){var c=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(){for(var r=0;r<c.length;r++)t=c[r],0<=(n=t.getBoundingClientRect()).bottom&&0<=n.left&&n.top<=(e.innerHeight+240||document.documentElement.clientHeight+240)&&function(){var t,n,e,i,o=c[r];t=o,n=function(){c=c.filter(function(t){return o!==t})},e=new Image,i=t.getAttribute("data-original"),e.onload=function(){t.src=i,n&&n()},e.src=i}();var t,n}i(),e.addEventListener("scroll",function(){var t,n;t=i,n=e,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(n)},500)})}(this);</script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script></body>

</html>
